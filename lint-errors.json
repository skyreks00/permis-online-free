[{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\App.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\components\\ChatAssistant.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'messages.length'. Either include it or remove the dependency array.","line":25,"column":8,"nodeType":"ArrayExpression","endLine":25,"endColumn":26,"suggestions":[{"desc":"Update the dependencies array to be: [isOpen, messages.length, mistakes]","fix":{"range":[1048,1066],"text":"[isOpen, messages.length, mistakes]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":68,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":68,"endColumn":23}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useRef, useEffect } from 'react';\r\nimport { createPortal } from 'react-dom';\r\nimport { MessageCircle, X, Send, Bot, User } from 'lucide-react';\r\nimport { getChatResponse } from '../utils/groq';\r\n\r\nconst ChatAssistant = ({ mistakes }) => {\r\n    const [isOpen, setIsOpen] = useState(false);\r\n    const [messages, setMessages] = useState([]);\r\n    const [input, setInput] = useState('');\r\n    const [isLoading, setIsLoading] = useState(false);\r\n    const messagesEndRef = useRef(null);\r\n\r\n    const apiKey = localStorage.getItem('groq_api_key');\r\n\r\n    useEffect(() => {\r\n        if (isOpen && messages.length === 0) {\r\n            // Initial greeting\r\n            setMessages([\r\n                {\r\n                    role: 'assistant',\r\n                    content: `Bonjour ! Je vois que vous avez fait ${mistakes.length} erreur${mistakes.length > 1 ? 's' : ''}. Je suis l√† pour vous aider √† comprendre. Posez-moi une question ou demandez-moi d'analyser vos fautes.`\r\n                }\r\n            ]);\r\n        }\r\n    }, [isOpen, mistakes]);\r\n\r\n    useEffect(() => {\r\n        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n    }, [messages]);\r\n\r\n    const handleSend = async () => {\r\n        if (!input.trim() || !apiKey) return;\r\n\r\n        const userMsg = { role: 'user', content: input };\r\n        setMessages(prev => [...prev, userMsg]);\r\n        setInput('');\r\n        setIsLoading(true);\r\n\r\n        // Prepare context\r\n        const systemPrompt = {\r\n            role: 'system',\r\n            content: `Tu es un moniteur d'auto-√©cole exp√©riment√©, cool et humain. \r\n            L'utilisateur vient de faire quelques fautes au code, pas de panique !\r\n            \r\n            TES OBJECTIFS :\r\n            TES OBJECTIFS :\r\n            1. √ätre BREF et DIRECT. Pas de pav√©s. Une r√©ponse = 2 ou 3 phrases max.\r\n            2. Adopter un ton oral, encourageant et naturel (tu peux utiliser \"on\", \"t'inqui√®te\", etc.).\r\n            3. Expliquer SIMPLEMENT pourquoi la r√©ponse de l'utilisateur est fausse, sans jargon compliqu√©.\r\n            4. Si on te pose une question, r√©ponds comme un vrai humain, pas comme un robot.\r\n            5. STRICTEMENT INTERDIT : Ne r√©ponds PAS aux sujets hors-sujet (politique, cuisine, etc.). Dis gentiment que tu ne parles que du Code de la Route.\r\n\r\n            Contexte des erreurs (Question | R√©ponse Utilisateur | Bonne r√©ponse | Explication):\r\n            ${mistakes.map((m) => `\r\n                Question ${m.questionIndex + 1} (ID: ${m.q.id}): ${m.q.question}\r\n                Il a r√©pondu: ${m.a.userAnswer || 'Rien'}\r\n                Il fallait r√©pondre: ${m.q.correctAnswer}\r\n                Pourquoi: ${m.q.explanation}\r\n            `).join('\\n')}\r\n            `\r\n        };\r\n\r\n        const apiMessages = [systemPrompt, ...messages, userMsg];\r\n\r\n        try {\r\n            const response = await getChatResponse(apiKey, apiMessages);\r\n            setMessages(prev => [...prev, { role: 'assistant', content: response }]);\r\n        } catch (error) {\r\n            setMessages(prev => [...prev, { role: 'assistant', content: \"D√©sol√©, je ne peux pas r√©pondre pour le moment. V√©rifiez votre cl√© API.\" }]);\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    if (!apiKey) return null; // Don't show if no key\r\n\r\n    return createPortal(\r\n        <>\r\n            {/* Floating Button */}\r\n            {!isOpen && (\r\n                <div\r\n                    className=\"fixed bottom-6 right-6 z-[9999]\"\r\n                    style={{ position: 'fixed', bottom: '24px', right: '24px' }}\r\n                >\r\n                    <button\r\n                        onClick={() => setIsOpen(true)}\r\n                        className=\"btn-primary shadow-lg flex items-center justify-center transition-transform hover:scale-110 active:scale-95\"\r\n                        title=\"Discuter avec le moniteur IA\"\r\n                        style={{\r\n                            width: '60px',\r\n                            height: '60px',\r\n                            borderRadius: '50%',\r\n                            padding: 0,\r\n                            animation: 'chat-open 0.3s cubic-bezier(0.16, 1, 0.3, 1)'\r\n                        }}\r\n                    >\r\n                        <Bot size={32} />\r\n                    </button>\r\n                </div>\r\n            )}\r\n\r\n            {/* Chat Window with Backdrop */}\r\n            {isOpen && (\r\n                <>\r\n                    {/* Backdrop - Click to close */}\r\n                    <div\r\n                        className=\"fixed inset-0 z-[9990]\"\r\n                        style={{\r\n                            position: 'fixed',\r\n                            top: 0,\r\n                            left: 0,\r\n                            right: 0,\r\n                            bottom: 0,\r\n                            backgroundColor: 'rgba(0,0,0,0.5)',\r\n                            transition: 'opacity 0.3s'\r\n                        }}\r\n                        onClick={() => setIsOpen(false)}\r\n                    />\r\n\r\n                    {/* Chat Container */}\r\n                    <div\r\n                        className=\"z-[9999]\"\r\n                        style={{\r\n                            position: 'fixed',\r\n                            bottom: '24px',\r\n                            right: '24px',\r\n                            width: '320px',\r\n                            height: '450px',\r\n                            maxWidth: 'calc(100vw - 3rem)',\r\n                            backgroundColor: 'var(--surface)',\r\n                            border: '1px solid var(--border)',\r\n                            borderRadius: '12px',\r\n                            boxShadow: '0 8px 30px rgba(0,0,0,0.5)',\r\n                            display: 'flex',\r\n                            flexDirection: 'column',\r\n                            overflow: 'hidden',\r\n                            transformOrigin: 'bottom right',\r\n                            animation: 'chat-open 0.3s cubic-bezier(0.16, 1, 0.3, 1)'\r\n                        }}\r\n                    >\r\n                        {/* Header */}\r\n                        <div\r\n                            className=\"p-3 flex justify-between items-center rounded-t-xl\"\r\n                            style={{\r\n                                borderBottom: '1px solid var(--border)',\r\n                                backgroundColor: 'var(--surface-2)',\r\n                                flexShrink: 0\r\n                            }}\r\n                        >\r\n                            <div\r\n                                className=\"flex items-center gap-2 font-bold text-primary\"\r\n                                style={{ paddingLeft: '16px' }}\r\n                            >\r\n                                <Bot size={20} /> Moniteur IA\r\n                            </div>\r\n                            <button\r\n                                onClick={() => setIsOpen(false)}\r\n                                className=\"text-muted hover-text-primary hover-scale\"\r\n                                style={{ background: 'none', border: 'none', cursor: 'pointer' }}\r\n                            >\r\n                                <X size={20} />\r\n                            </button>\r\n                        </div>\r\n\r\n                        {/* Messages */}\r\n                        <div\r\n                            className=\"flex-1 p-4 no-scrollbar\"\r\n                            style={{\r\n                                flex: '1 1 auto',\r\n                                minHeight: 0,\r\n                                overflowY: 'auto',\r\n                                display: 'flex',\r\n                                flexDirection: 'column',\r\n                                gap: '16px' // Explicit gap for vertical spacing\r\n                            }}\r\n                        >\r\n                            {messages.map((m, i) => (\r\n                                <div\r\n                                    key={i}\r\n                                    style={{\r\n                                        display: 'flex',\r\n                                        justifyContent: m.role === 'user' ? 'flex-end' : 'flex-start',\r\n                                        width: '100%'\r\n                                    }}\r\n                                >\r\n                                    <div\r\n                                        style={{\r\n                                            maxWidth: '85%',\r\n                                            padding: '12px 16px', // Comfortable padding\r\n                                            borderRadius: '12px',\r\n                                            backgroundColor: m.role === 'user' ? 'var(--primary)' : 'var(--surface-2)',\r\n                                            color: m.role === 'user' ? '#fff' : 'var(--text)',\r\n                                            borderTopRightRadius: m.role === 'user' ? '4px' : '12px',\r\n                                            borderTopLeftRadius: m.role === 'user' ? '12px' : '4px',\r\n                                            borderBottomLeftRadius: '12px',\r\n                                            borderBottomRightRadius: '12px',\r\n                                            border: m.role === 'assistant' ? '1px solid var(--border)' : 'none',\r\n                                            wordBreak: 'break-word',\r\n                                            lineHeight: '1.5',\r\n                                            boxShadow: '0 1px 2px rgba(0,0,0,0.1)'\r\n                                        }}\r\n                                    >\r\n                                        {m.content}\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                            {isLoading && (\r\n                                <div className=\"flex justify-start\">\r\n                                    <div\r\n                                        className=\"p-4 rounded-lg flex gap-1\"\r\n                                        style={{ backgroundColor: 'var(--surface-2)', borderTopLeftRadius: 0 }}\r\n                                    >\r\n                                        <span className=\"w-2 h-2 bg-muted rounded-full animate-bounce\"></span>\r\n                                        <span className=\"w-2 h-2 bg-muted rounded-full animate-bounce delay-100\"></span>\r\n                                        <span className=\"w-2 h-2 bg-muted rounded-full animate-bounce delay-200\"></span>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                            <div ref={messagesEndRef} />\r\n                        </div>\r\n\r\n                        {/* Input */}\r\n                        <div\r\n                            className=\"p-4 flex gap-2\"\r\n                            style={{\r\n                                borderTop: '1px solid var(--border)',\r\n                                flexShrink: 0\r\n                            }}\r\n                        >\r\n                            <input\r\n                                type=\"text\"\r\n                                value={input}\r\n                                onChange={e => setInput(e.target.value)}\r\n                                onKeyDown={e => e.key === 'Enter' && handleSend()}\r\n                                placeholder=\"Posez une question...\"\r\n                                className=\"input flex-1 text-sm h-10\"\r\n                                disabled={isLoading}\r\n                                style={{\r\n                                    backgroundColor: 'var(--bg-elev)',\r\n                                    border: '1px solid var(--border)',\r\n                                    color: 'var(--text)',\r\n                                    borderRadius: '8px',\r\n                                    padding: '10px 14px'\r\n                                }}\r\n                            />\r\n                            <button\r\n                                onClick={handleSend}\r\n                                disabled={isLoading || !input.trim()}\r\n                                className=\"btn-primary h-10 w-10 p-0 flex items-center justify-center rounded-lg\"\r\n                                style={{\r\n                                    backgroundColor: 'var(--primary)',\r\n                                    border: 'none',\r\n                                    color: 'white',\r\n                                    cursor: 'pointer',\r\n                                    display: 'grid',\r\n                                    placeItems: 'center'\r\n                                }}\r\n                            >\r\n                                <Send size={18} />\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </>\r\n            )}\r\n        </>,\r\n        document.body\r\n    );\r\n};\r\n\r\nexport default ChatAssistant;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\components\\LessonList.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\components\\LessonPage.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  27 |   useEffect(() => {\n  28 |     if (!lesson) {\n> 29 |       setError('Le√ßon introuvable.');\n     |       ^^^^^^^^ Avoid calling setState() directly within an effect\n  30 |       setLoading(false);\n  31 |       return;\n  32 |     }","line":29,"column":7,"nodeType":null,"endLine":29,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { useParams, Link } from 'react-router-dom';\r\nimport ReactMarkdown from 'react-markdown';\r\nimport { lessons } from '../data/lessons';\r\n\r\nconst LessonPage = () => {\r\n  const { slug } = useParams();\r\n  const lesson = lessons.find((l) => l.slug === slug);\r\n  const [content, setContent] = useState('');\r\n  const [error, setError] = useState(null);\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  const normalizeFileName = (filename) => {\r\n    if (!filename) return '';\r\n    let name = String(filename).replace(/\\.md$/i, '').toLowerCase();\r\n    name = name.replace(/le√ßon/gi, '').replace(/lecon/gi, '').trim();\r\n    name = name.replace(/\\s+/g, '_').replace(/_+/g, '_').replace(/^_+/, '');\r\n    const m = name.match(/\\d+/);\r\n    if (m) {\r\n      const num = m[0];\r\n      const rest = name.replace(/^\\d+_?/, '');\r\n      name = `${num}_${rest}`;\r\n    }\r\n    return `${name}.md`;\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (!lesson) {\r\n      setError('Le√ßon introuvable.');\r\n      setLoading(false);\r\n      return;\r\n    }\r\n    const normalized = normalizeFileName(lesson.file);\r\n    const url = `/lecon/${encodeURIComponent(normalized)}`;\r\n    fetch(url)\r\n      .then((res) => {\r\n        if (!res.ok) throw new Error(`Impossible de charger ${lesson.file}`);\r\n        const ct = res.headers.get('content-type') || '';\r\n        return res.text().then((text) => ({ ct, text }));\r\n      })\r\n      .then(({ ct, text }) => {\r\n        // If Vite returned the app shell (HTML), the file doesn't exist in public/lecon\r\n        const looksHtml = ct.includes('text/html') || /<html[\\s\\S]*<\\/html>/i.test(text);\r\n        if (looksHtml) {\r\n          setError(`Fichier introuvable: ${lesson.file}. Placez les fichiers Markdown dans code-route-app/public/lecon/`);\r\n        } else {\r\n          setContent(text);\r\n        }\r\n        setLoading(false);\r\n      })\r\n      .catch((e) => {\r\n        setError(e.message);\r\n        setLoading(false);\r\n      });\r\n  }, [lesson]);\r\n\r\n  return (\r\n    <div className=\"container\">\r\n      <div className=\"actions\" style={{ justifyContent: 'space-between' }}>\r\n        <Link className=\"btn-ghost\" to=\"/lecons\">‚Üê Retour aux le√ßons</Link>\r\n        <Link className=\"btn-ghost\" to=\"/\">üèÅ Aller au quiz</Link>\r\n      </div>\r\n\r\n      <div className=\"card\" style={{ padding: 20 }}>\r\n        <h1 style={{ marginBottom: 6 }}>{lesson?.title ?? 'Le√ßon'}</h1>\r\n        {loading && <p>Chargement‚Ä¶</p>}\r\n        {error && <p className=\"muted\">{error}</p>}\r\n        {!loading && !error && (\r\n          <div className=\"markdown\">\r\n            <ReactMarkdown>{content}</ReactMarkdown>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default LessonPage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\components\\LessonViewer.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'useRef' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"useRef"},"fix":{"range":[12,24],"text":""},"desc":"Remove unused variable 'useRef'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useRef } from 'react';\r\nimport globalStyles from '../assets/styles.css?inline';\r\nimport { ArrowLeft } from 'lucide-react';\r\n\r\nconst LessonViewer = ({ lessonFile, onBack, theme }) => {\r\n    const [srcDoc, setSrcDoc] = React.useState('');\r\n    const [loading, setLoading] = React.useState(true);\r\n\r\n    React.useEffect(() => {\r\n        const fetchLesson = async () => {\r\n            setLoading(true);\r\n            try {\r\n                const base = import.meta.env.BASE_URL || '/';\r\n                const response = await fetch(`${base}lecon/${lessonFile}`);\r\n                const html = await response.text();\r\n\r\n                // Parse the HTML\r\n                const parser = new DOMParser();\r\n                const doc = parser.parseFromString(html, 'text/html');\r\n\r\n                // 1. Inject global theme attribute\r\n                doc.documentElement.setAttribute('data-theme', theme);\r\n\r\n                // 2. Inject Styles\r\n                const style = doc.createElement('style');\r\n                style.textContent = globalStyles + `\r\n                    /* Ensure text color is inherited everywhere */\r\n                    body, p, h1, h2, h3, h4, h5, h6, li, td, span, div {\r\n                        color: inherit;\r\n                    }\r\n                    /* Custom classes from lessons */\r\n                    .box-yellow {\r\n                        background-color: color-mix(in oklab, var(--warning) 10%, transparent);\r\n                        border: 1px solid var(--warning);\r\n                        padding: 15px;\r\n                        border-radius: 8px;\r\n                        margin: 15px 0;\r\n                    }\r\n                    .red, .text-red {\r\n                        color: var(--danger) !important;\r\n                    }\r\n                    .subtitle {\r\n                        color: var(--primary);\r\n                        font-weight: 600;\r\n                        margin-bottom: 5px;\r\n                    }\r\n\r\n                    .lesson-video {\r\n                        width: 100%;\r\n                        aspect-ratio: 16 / 9;\r\n                        height: auto;\r\n                        border-radius: 8px;\r\n                        display: block;\r\n                        margin: 20px 0;\r\n                        border: none;\r\n                    }\r\n\r\n                    /* Scrollbar styling */\r\n                    ::-webkit-scrollbar {\r\n                        width: 10px;\r\n                        height: 10px;\r\n                    }\r\n                    ::-webkit-scrollbar-track {\r\n                        background: transparent;\r\n                    }\r\n                    ::-webkit-scrollbar-thumb {\r\n                        background: var(--border);\r\n                        border-radius: 5px;\r\n                        border: 2px solid var(--bg);\r\n                    }\r\n                    ::-webkit-scrollbar-thumb:hover {\r\n                        background: var(--muted);\r\n                    }\r\n\r\n                    img {\r\n                        max-width: 100%;\r\n                        height: auto;\r\n                        display: inline-block;\r\n                        border-radius: 8px;\r\n                        margin-right: 4px;\r\n                        vertical-align: middle;\r\n                    }\r\n                    /* Use specific styling for the layout tables */\r\n                    .lesson-detail-table {\r\n                        width: 100%;\r\n                        border-collapse: separate;\r\n                        border-spacing: 0 10px;\r\n                    }\r\n                    .lesson-detail-table td {\r\n                        vertical-align: top;\r\n                        padding: 10px;\r\n                        background: color-mix(in oklab, var(--surface) 50%, transparent);\r\n                        border-radius: 8px;\r\n                    }\r\n                    /* Force the image column (first column) to a fixed width container */\r\n                    .lesson-detail-table td:first-child {\r\n                        width: 280px;\r\n                        min-width: 280px;\r\n                        vertical-align: top;\r\n                    }\r\n                    /* Use flexbox on P tags to handle multiple images side-by-side in the first column */\r\n                    .lesson-detail-table td:first-child p {\r\n                        display: flex;\r\n                        flex-wrap: wrap;\r\n                        justify-content: center;\r\n                        gap: 8px;\r\n                        margin: 0 0 8px 0;\r\n                    }\r\n                    /* Images are flex items in first col, but inline-block elsewhere */\r\n                    .lesson-detail-table img {\r\n                        flex: 1 1 120px; \r\n                        max-width: 100%;\r\n                        width: auto;\r\n                        height: auto;\r\n                        max-height: 180px; \r\n                        object-fit: contain;\r\n                        background-color: transparent;\r\n                        display: inline-block;\r\n                        margin-right: 4px;\r\n                    }\r\n                    /* Clean up paragraphs with no images if needed, or links */\r\n                    .lesson-detail-table td:first-child a {\r\n                        display: contents; \r\n                    }\r\n                    /* Sign tables (usually 3 columns) should not be forced */\r\n                    .lesson-signs-3-columns td {\r\n                        text-align: center;\r\n                        padding: 10px;\r\n                    }\r\n                    .lesson-signs-3-columns img {\r\n                        max-height: 150px;\r\n                        width: auto;\r\n                        margin: 0 auto;\r\n                    }\r\n                    \r\n                    /* Body styling */\r\n                    body {\r\n                        max-width: 1100px;\r\n                        margin: 0 auto;\r\n                        padding: 20px;\r\n                        background-color: var(--bg);\r\n                        color: var(--text);\r\n                        overflow-y: auto; /* Allow scrolling inside iframe body */\r\n                    }\r\n\r\n                    /* Mobile Responsive for Lesson Content */\r\n                    @media (max-width: 600px) {\r\n                        body {\r\n                            padding: 12px;\r\n                        }\r\n                        .lesson-detail-table, .lesson-detail-table tbody, .lesson-detail-table tr, .lesson-detail-table td {\r\n                            display: block;\r\n                            width: 100% !important;\r\n                            min-width: 0 !important;\r\n                            box-sizing: border-box;\r\n                        }\r\n                        .lesson-detail-table td:first-child {\r\n                            width: 100%;\r\n                            min-width: 0;\r\n                            margin-bottom: 15px;\r\n                            border-bottom: 1px solid var(--border);\r\n                            padding-bottom: 15px;\r\n                        }\r\n                        .lesson-detail-table img {\r\n                            max-height: 200px;\r\n                            width: auto;\r\n                            margin: 0 auto;\r\n                            display: block;\r\n                        }\r\n                        .lesson-detail-table td:first-child p {\r\n                            justify-content: center;\r\n                        }\r\n                    }\r\n                `;\r\n                doc.head.appendChild(style);\r\n\r\n                // 3. Fix Image Paths\r\n                const images = doc.body.getElementsByTagName('img');\r\n                for (let img of images) {\r\n                    const src = img.getAttribute('src');\r\n                    if (src && src.startsWith('uploads/')) {\r\n                        img.src = `https://www.permisdeconduire-online.be/${src}`;\r\n                    }\r\n                }\r\n\r\n                // 3b. Fix Videos (add fullscreen and styling helpers)\r\n                const iframes = doc.body.getElementsByTagName('iframe');\r\n                for (let iframe of iframes) {\r\n                    iframe.setAttribute('allowfullscreen', 'true');\r\n                    iframe.setAttribute('mozallowfullscreen', 'true');\r\n                    iframe.setAttribute('webkitallowfullscreen', 'true');\r\n                    iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');\r\n\r\n                    // Add class if not present\r\n                    if (!iframe.classList.contains('lesson-video')) {\r\n                        iframe.classList.add('lesson-video');\r\n                    }\r\n                }\r\n\r\n                // 4. Remove Footer Sections\r\n                const h2s = Array.from(doc.body.getElementsByTagName('h2'));\r\n                const startHeader = h2s.find(h2 =>\r\n                    h2.textContent.trim() === 'Exercices' ||\r\n                    h2.textContent.trim() === 'Les examens'\r\n                );\r\n\r\n                if (startHeader) {\r\n                    const prev = startHeader.previousElementSibling;\r\n                    if (prev && prev.tagName === 'HR') {\r\n                        prev.remove();\r\n                    }\r\n                    let currentElement = startHeader;\r\n                    while (currentElement) {\r\n                        const nextElement = currentElement.nextElementSibling;\r\n                        currentElement.remove();\r\n                        currentElement = nextElement;\r\n                    }\r\n                }\r\n                const links = Array.from(doc.body.getElementsByTagName('a'));\r\n                const retourLink = links.find(a => a.textContent.includes('Retour √† la page pr√©c√©dente'));\r\n                if (retourLink) {\r\n                    const container = retourLink.closest('div.align-center') || retourLink;\r\n                    container.remove();\r\n                }\r\n\r\n                // Serialize back to string\r\n                setSrcDoc(doc.documentElement.outerHTML);\r\n                setLoading(false);\r\n\r\n            } catch (error) {\r\n                console.error(\"Failed to load lesson:\", error);\r\n                setSrcDoc(`<p>Erreur lors du chargement de la le√ßon.</p>`);\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        fetchLesson();\r\n\r\n        // Lock body scroll\r\n        document.body.style.overflow = 'hidden';\r\n        return () => {\r\n            document.body.style.overflow = '';\r\n        };\r\n    }, [lessonFile, theme]);\r\n\r\n    return (\r\n        <div className=\"lesson-viewer\" style={{\r\n            position: 'fixed',\r\n            top: 0,\r\n            left: 0,\r\n            width: '100vw',\r\n            height: '100vh',\r\n            zIndex: 100,\r\n            backgroundColor: 'var(--bg)',\r\n            display: 'flex',\r\n            flexDirection: 'column'\r\n        }}>\r\n            <div className=\"actions\" style={{\r\n                padding: '12px 20px',\r\n                borderBottom: '1px solid var(--border)',\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                backgroundColor: 'var(--surface)',\r\n                gap: '16px'\r\n            }}>\r\n                <button className=\"btn-ghost\" onClick={onBack} style={{ border: '1px solid var(--border)', display: 'flex', alignItems: 'center', gap: '6px' }}>\r\n                    <ArrowLeft size={16} /> Retour\r\n                </button>\r\n                <span style={{ fontWeight: 600, fontSize: '1.1rem' }}>Le√ßon</span>\r\n            </div>\r\n            <div style={{ flex: 1, display: 'flex', overflow: 'hidden', position: 'relative' }}>\r\n                <div style={{\r\n                    opacity: loading ? 1 : 0,\r\n                    position: 'absolute',\r\n                    inset: 0,\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    justifyContent: 'center',\r\n                    pointerEvents: 'none',\r\n                    transition: 'opacity 0.2s'\r\n                }}>\r\n                    Chargement...\r\n                </div>\r\n                <iframe\r\n                    srcDoc={srcDoc}\r\n                    title=\"Le√ßon\"\r\n                    style={{\r\n                        width: '100%',\r\n                        height: '100%',\r\n                        border: 'none',\r\n                        opacity: loading ? 0 : 1,\r\n                        transition: 'opacity 0.3s ease-in-out'\r\n                    }}\r\n                />\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default LessonViewer;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\components\\LessonsViewer.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\components\\Profile.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'githubToken'. Either include it or remove the dependency array.","line":66,"column":8,"nodeType":"ArrayExpression","endLine":66,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [githubToken]","fix":{"range":[2853,2855],"text":"[githubToken]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'_e' is defined but never used.","line":90,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":90,"endColumn":24},{"ruleId":"no-unused-vars","severity":2,"message":"'_e' is defined but never used.","line":175,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":175,"endColumn":28}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { Trophy, Target, AlertTriangle, Clock, Settings, ArrowLeft, CheckCircle2, Circle, Volume2, User, LogOut, Key, Github, Save, Filter, RefreshCcw } from 'lucide-react';\r\nimport { getUser } from '../utils/githubClient';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { loadThemeQuestions } from '../utils/contentLoader';\r\n\r\nconst Profile = ({ progress, themesData, onBack, onReset, instantFeedback, onToggleInstantFeedback, autoPlayAudio, onToggleAutoPlayAudio }) => {\r\n    const navigate = useNavigate();\r\n    const [showErrorsOnly, setShowErrorsOnly] = useState(false);\r\n    const [isLoadingReview, setIsLoadingReview] = useState(false);\r\n\r\n    // --- Stats Calculation ---\r\n    const getNormalizedProgress = (p) => {\r\n        const score = p.bestScore !== undefined ? p.bestScore : (p.score || 0);\r\n        const total = p.totalQuestions !== undefined ? p.totalQuestions : (p.total || 0);\r\n        return { score, total };\r\n    };\r\n\r\n    const progressValues = Object.values(progress);\r\n    const totalQuizzes = progressValues.length;\r\n    \r\n    const globalStats = progressValues.reduce((acc, p) => {\r\n        const { score, total } = getNormalizedProgress(p);\r\n        return {\r\n            bestScore: acc.bestScore + score,\r\n            totalQuestions: acc.totalQuestions + total\r\n        };\r\n    }, { bestScore: 0, totalQuestions: 0 });\r\n\r\n    const totalBestScore = globalStats.bestScore;\r\n    const totalMaxPossible = globalStats.totalQuestions;\r\n    const averageAccuracy = totalMaxPossible > 0 ? Math.round((totalBestScore / totalMaxPossible) * 100) : 0;\r\n    const totalMistakes = totalMaxPossible - totalBestScore;\r\n\r\n    const statedThemes = (themesData.sections || [])\r\n        .flatMap(section => section.items || section.themes || [])\r\n        .filter(t => t && t.id && progress[t.id]);\r\n\r\n    const filteredThemes = showErrorsOnly \r\n        ? statedThemes.filter(t => {\r\n            const { score, total } = getNormalizedProgress(progress[t.id]);\r\n            return score < total;\r\n        })\r\n        : statedThemes;\r\n\r\n    // --- Developer Mode State ---\r\n    const [apiKey, setApiKey] = useState(() => localStorage.getItem('groq_api_key') || '');\r\n    const [githubToken, setGithubToken] = useState(() => localStorage.getItem('github_token') || '');\r\n    const [githubUser, setGithubUser] = useState(null);\r\n    const [showConfirmReset, setShowConfirmReset] = useState(false);\r\n\r\n    const fetchGithubUser = async (token) => {\r\n        try {\r\n            const user = await getUser(token);\r\n            setGithubUser(user);\r\n        } catch (e) {\r\n            console.error(\"Invalid token:\", e);\r\n            setGithubUser(null);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        if (githubToken) {\r\n            fetchGithubUser(githubToken);\r\n        }\r\n    }, []);\r\n\r\n    const handleSaveKeys = () => {\r\n        if (apiKey) localStorage.setItem('groq_api_key', apiKey);\r\n        else localStorage.removeItem('groq_api_key');\r\n\r\n        if (githubToken) {\r\n            localStorage.setItem('github_token', githubToken);\r\n            fetchGithubUser(githubToken);\r\n        } else {\r\n            localStorage.removeItem('github_token');\r\n            setGithubUser(null);\r\n        }\r\n        alert('Param√®tres sauvegard√©s !');\r\n    };\r\n\r\n    const handleReview = async (theme) => {\r\n        setIsLoadingReview(true);\r\n        try {\r\n            // Load questions for the theme\r\n            let questions = [];\r\n            try {\r\n                const data = await loadThemeQuestions(theme.file);\r\n                questions = data.questions || [];\r\n            } catch (_e) {\r\n                // Fallback fetch\r\n                const res = await fetch(`data/${theme.file}`);\r\n                const json = await res.json();\r\n                questions = json.questions || [];\r\n            }\r\n\r\n            if (questions.length === 0) {\r\n                alert(\"Impossible de charger les questions pour la r√©vision.\");\r\n                return;\r\n            }\r\n\r\n            const p = progress[theme.id];\r\n            const savedAnswers = p.answers || []; // Array of { questionId, userAnswer, isCorrect ... } (hopefully)\r\n\r\n            // Map saved answers to questions by ID\r\n            // If p.answers is array of objects with questionId, great.\r\n            // If it's old array of undefined/objects, we try our best.\r\n            // Current Quiz.jsx saves: { questionId, userAnswer, correctAnswer, isCorrect }\r\n            \r\n            const questionsToReview = [];\r\n            \r\n            // Iterate over SAVED ANSWERS if available to match with questions\r\n            if (savedAnswers.length > 0) {\r\n                savedAnswers.forEach((ans) => {\r\n                    if (ans && ans.isCorrect === false) {\r\n                        // Use loose equality for ID matching\r\n                        const q = questions.find(q => q.id == ans.questionId);\r\n                        if (q) {\r\n                            // Attach originalThemeId and sourceFile for tracking\r\n                            questionsToReview.push({ \r\n                                ...q, \r\n                                originalThemeId: theme.id,\r\n                                sourceFile: theme.file \r\n                            });\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n\r\n            if (questionsToReview.length === 0) {\r\n                alert(\"Erreur: Impossible de retrouver les questions.\");\r\n                return;\r\n            }\r\n\r\n\r\n\r\n            navigate('/quiz/review', {\r\n                state: {\r\n                    questions: questionsToReview,\r\n                    title: `R√©vision: ${theme.name}`,\r\n                    isReview: true\r\n                }\r\n            });\r\n\r\n        } catch (error) {\r\n            console.error(\"Erreur r√©vision:\", error);\r\n            alert(\"Erreur lors du chargement de la r√©vision.\");\r\n        } finally {\r\n            setIsLoadingReview(false);\r\n        }\r\n    };\r\n\r\n    const handleReviewAll = async () => {\r\n        setIsLoadingReview(true);\r\n        try {\r\n            const allErrors = [];\r\n            \r\n            // Get all themes that have progress\r\n            const themesToReview = statedThemes.filter(t => {\r\n                const { score, total } = getNormalizedProgress(progress[t.id]);\r\n                return score < total;\r\n            });\r\n\r\n            if (themesToReview.length === 0) {\r\n                alert(\"Aucune faute √† r√©viser !\");\r\n                setIsLoadingReview(false);\r\n                return;\r\n            }\r\n\r\n            for (const theme of themesToReview) {\r\n                 let questions = [];\r\n                try {\r\n                    const data = await loadThemeQuestions(theme.file);\r\n                    questions = data.questions || [];\r\n                } catch (_e) {\r\n                    const res = await fetch(`data/${theme.file}`);\r\n                    const json = await res.json();\r\n                    questions = json.questions || [];\r\n                }\r\n\r\n                const p = progress[theme.id];\r\n                const savedAnswers = p.answers || [];\r\n\r\n                if (savedAnswers.length > 0) {\r\n                     savedAnswers.forEach((ans) => {\r\n                        if (ans && ans.isCorrect === false) {\r\n                            // Use loose equality\r\n                            const q = questions.find(q => q.id == ans.questionId);\r\n                            if (q) {\r\n                                // Include themeId and sourceFile so we can patch it later\r\n                                allErrors.push({ \r\n                                    q, \r\n                                    a: ans, \r\n                                    idx: allErrors.length, \r\n                                    themeId: theme.id,\r\n                                    sourceFile: theme.file \r\n                                });\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n\r\n            if (allErrors.length === 0) {\r\n                alert(\"Aucune erreur trouv√©e dans les sauvegardes.\");\r\n                return;\r\n            }\r\n\r\n            // Extract just the question objects, injecting the theme ID for tracking\r\n            const questionsToReview = allErrors.map(item => ({\r\n                ...item.q,\r\n                originalThemeId: item.themeId,\r\n                sourceFile: item.sourceFile\r\n            }));\r\n\r\n            navigate('/quiz/review', {\r\n                state: {\r\n                    questions: questionsToReview,\r\n                    title: \"R√©vision des fautes (Global)\",\r\n                    isReview: true\r\n                }\r\n            });\r\n\r\n        } catch(e) {\r\n            console.error(e);\r\n            alert(\"Erreur lors de la pr√©paration de la r√©vision globale.\");\r\n        } finally {\r\n             setIsLoadingReview(false);\r\n        }\r\n    };\r\n\r\n    if (isLoadingReview) {\r\n        return <div className=\"page container flex items-center justify-center h-screen\">Chargement de la r√©vision...</div>;\r\n    }\r\n\r\n    return (\r\n        <div className=\"page container animate-fade-in\" style={{ maxWidth: '1200px' }}>\r\n            <div className=\"mb-6\">\r\n                <button\r\n                    onClick={onBack}\r\n                    className=\"btn-ghost flex items-center gap-2\"\r\n                >\r\n                    <ArrowLeft size={20} /> Retour\r\n                </button>\r\n            </div>\r\n\r\n            {/* Stats Grid */}\r\n            <div className=\"profile-stats-grid\">\r\n                <div className=\"stat-card\">\r\n                    <div className=\"stat-icon primary\">\r\n                        <Trophy size={24} />\r\n                    </div>\r\n                    <div className=\"stat-content\">\r\n                        <div className=\"stat-label\">Moyenne Globale</div>\r\n                        <div className=\"stat-value\">{averageAccuracy}%</div>\r\n                    </div>\r\n                </div>\r\n                <div className=\"stat-card\">\r\n                    <div className=\"stat-icon info\">\r\n                        <Target size={24} />\r\n                    </div>\r\n                    <div className=\"stat-content\">\r\n                        <div className=\"stat-label\">Quiz Termin√©s</div>\r\n                        <div className=\"stat-value\">{totalQuizzes}</div>\r\n                    </div>\r\n                </div>\r\n                <div className=\"stat-card relative overflow-hidden\">\r\n                    <div className=\"stat-icon danger\">\r\n                        <AlertTriangle size={24} />\r\n                    </div>\r\n                    <div className=\"stat-content z-10 relative w-full\">\r\n                        <div className=\"stat-label\">Fautes √† revoir</div>\r\n                        <div className=\"stat-value\">{totalMistakes}</div>\r\n                        <div className=\"flex flex-row items-center justify-between w-full mt-1\">\r\n                            <div className=\"stat-sub\">{totalMistakes} erreurs au total</div>\r\n                            {totalMistakes > 0 && (\r\n                                <button \r\n                                    onClick={handleReviewAll}\r\n                                    className=\"btn-primary btn-sm flex items-center gap-1 px-3 py-2\"\r\n                                >\r\n                                    <RefreshCcw size={16} /> R√©viser\r\n                                </button>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"profile-content-grid\">\r\n\r\n                {/* Left Column: History & Progress */}\r\n                <div className=\"card p-6 bg-surface-1 border border-border\">\r\n                    <div className=\"flex items-center justify-between mb-6\">\r\n                        <h2 className=\"text-xl font-bold flex items-center gap-2\">\r\n                            <Clock size={20} /> Historique\r\n                        </h2>\r\n                        <button\r\n                            onClick={() => setShowErrorsOnly(!showErrorsOnly)}\r\n                            className={`btn-sm flex items-center gap-2 ${showErrorsOnly ? 'btn-danger' : 'btn-ghost'}`}\r\n                        >\r\n                            <Filter size={16} /> {showErrorsOnly ? 'Tout voir' : 'Voir les fautes'}\r\n                        </button>\r\n                    </div>\r\n\r\n                    <div className=\"theme-history-list\">\r\n                        {filteredThemes.length === 0 ? (\r\n                            <div className=\"text-center text-muted py-8\">\r\n                                {showErrorsOnly ? 'Aucune faute trouv√©e ! Bravo ! üéâ' : 'Aucun historique disponible. Commencez un quiz !'}\r\n                            </div>\r\n                        ) : (\r\n                            filteredThemes.map(theme => {\r\n                                const p = progress[theme.id];\r\n                                const { score, total } = getNormalizedProgress(p);\r\n                                const acc = total > 0 ? Math.round((score / total) * 100) : 0;\r\n                                \r\n                                // Color Logic: Green ONLY for 100%\r\n                                // Orange for >= 50% but < 100%\r\n                                // Red for < 50%\r\n                                let scoreColor;\r\n                                if (acc === 100) scoreColor = 'text-success';\r\n                                else if (acc >= 50) scoreColor = 'text-warning';\r\n                                else scoreColor = 'text-danger';\r\n\r\n                                return (\r\n                                    <div key={theme.id} className=\"theme-history-item flex items-center justify-between\">\r\n                                        <div>\r\n                                            <div className=\"font-medium\">{theme.name}</div>\r\n                                            <div className={`font-mono font-bold ${scoreColor}`}>\r\n                                                {score} / {total} ({acc}%)\r\n                                            </div>\r\n                                        </div>\r\n                                        {score < total && (\r\n                                            <button \r\n                                                onClick={() => handleReview(theme)}\r\n                                                className=\"btn-ghost text-primary btn-sm flex items-center gap-1 hover:bg-primary/10\"\r\n                                            >\r\n                                                <RefreshCcw size={14} /> R√©viser\r\n                                            </button>\r\n                                        )}\r\n                                    </div>\r\n                                );\r\n                            })\r\n                        )}\r\n                    </div>\r\n\r\n                    {Object.keys(progress).length > 0 && (\r\n                        <div className=\"mt-8 pt-6 border-t border-border\">\r\n                            {!showConfirmReset ? (\r\n                                <button\r\n                                    onClick={() => setShowConfirmReset(true)}\r\n                                    className=\"btn-ghost text-danger w-full flex items-center justify-center gap-2\"\r\n                                >\r\n                                    <LogOut size={16} /> R√©initialiser la progression\r\n                                </button>\r\n                            ) : (\r\n                                <div className=\"p-4 border border-danger rounded bg-danger/10 animate-fade-in\">\r\n                                    <p className=\"text-center mb-3 text-danger font-medium\">√ätes-vous s√ªr ?</p>\r\n                                    <div className=\"flex gap-3\">\r\n                                        <button onClick={() => setShowConfirmReset(false)} className=\"btn-ghost flex-1 text-sm\">Annuler</button>\r\n                                        <button onClick={() => { onReset(); setShowConfirmReset(false); }} className=\"btn-primary bg-danger border-danger hover:bg-danger/90 flex-1 text-white text-sm\">Confirmer</button>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Right Column: Settings & Developer Mode */}\r\n                <div className=\"settings-list\">\r\n\r\n                    {/* Preferences Card */}\r\n                    <div className=\"card p-6 bg-surface-1 border border-border\">\r\n                        <h2 className=\"text-xl font-bold mb-6 flex items-center gap-2\">\r\n                            <Settings size={20} /> Pr√©f√©rences\r\n                        </h2>\r\n\r\n                        <div className=\"flex items-center justify-between mb-6\">\r\n                            <div>\r\n                                <div className=\"font-semibold\">Correction Instantan√©e</div>\r\n                                <div className=\"text-sm text-muted\">Voir la r√©ponse juste apr√®s le clic.</div>\r\n                            </div>\r\n                            <label className=\"switch\">\r\n                                <input type=\"checkbox\" checked={instantFeedback} onChange={onToggleInstantFeedback} />\r\n                                <span className=\"slider round\"></span>\r\n                            </label>\r\n                        </div>\r\n\r\n                        <div className=\"flex items-center justify-between\">\r\n                            <div>\r\n                                <div className=\"font-semibold\">Lecture Audio Auto</div>\r\n                                <div className=\"text-sm text-muted\">Lire la question automatiquement.</div>\r\n                            </div>\r\n                            <label className=\"switch\">\r\n                                <input type=\"checkbox\" checked={autoPlayAudio} onChange={onToggleAutoPlayAudio} />\r\n                                <span className=\"slider round\"></span>\r\n                            </label>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Developer / Contributor Card */}\r\n                    <div className=\"card p-6 border-2 border-primary/20 bg-surface-1\">\r\n                        <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2 text-primary\">\r\n                            <Key size={20} /> Mode Contributeur\r\n                        </h2>\r\n\r\n                        <div className=\"mb-5\">\r\n                            <label className=\"block mb-1.5 font-semibold text-sm\">Groq API Key</label>\r\n                            <p className=\"text-xs text-muted mb-2\">\r\n                                Requise pour corrections IA (Llama 3). <a href=\"https://console.groq.com/keys\" target=\"_blank\" rel=\"noreferrer\" className=\"text-primary underline\">Obtenir une cl√©</a>\r\n                            </p>\r\n                            <input\r\n                                type=\"password\"\r\n                                className=\"input w-full\"\r\n                                value={apiKey}\r\n                                onChange={e => setApiKey(e.target.value)}\r\n                                placeholder=\"gsk_...\"\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"mb-6\">\r\n                            <label className=\"block mb-1.5 font-semibold text-sm flex items-center gap-2\">\r\n                                <Github size={16} /> GitHub Token (Optionnel)\r\n                            </label>\r\n                            <p className=\"text-xs text-muted mb-2\">\r\n                                Requis pour proposer des corrections (Pull Requests).\r\n                                <br />\r\n                                <a href=\"https://github.com/settings/tokens/new?scopes=public_repo\" target=\"_blank\" rel=\"noreferrer\" className=\"text-primary underline font-medium\">\r\n                                    G√©n√©rer un token (Classic)\r\n                                </a> avec le scope <code>public_repo</code>.\r\n                            </p>\r\n\r\n                            <input\r\n                                type=\"password\"\r\n                                className=\"input w-full mb-3\"\r\n                                value={githubToken}\r\n                                onChange={e => setGithubToken(e.target.value)}\r\n                                placeholder=\"ghp_...\"\r\n                            />\r\n\r\n                            {githubUser && (\r\n                                <div className=\"flex items-center gap-2 p-2 bg-success/10 rounded-lg text-success text-sm border border-success/20\">\r\n                                    <img src={githubUser.avatar_url} alt=\"\" style={{ width: '24px', height: '24px', borderRadius: '50%' }} />\r\n                                    <span>Connect√© en tant que <strong>{githubUser.login}</strong></span>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        <button onClick={handleSaveKeys} className=\"btn-primary w-full flex items-center justify-center gap-2\">\r\n                            <Save size={18} /> Enregistrer les cl√©s\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n                <div className=\"h-10\"></div>\r\n                \r\n                {/* CLOUD SYNC SECTION */}\r\n                {githubToken && githubUser && (\r\n                    <div className=\"card p-6 bg-surface-1 border border-primary/30 mt-8 mb-8\">\r\n                        <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2 text-primary\">\r\n                            <span style={{ fontSize: '1.5em' }}>‚òÅÔ∏è</span> Cloud Sync (Exp√©rimental)\r\n                        </h2>\r\n                        <p className=\"text-sm text-muted mb-4\">\r\n                            Sauvegardez votre progression dans votre d√©p√¥t GitHub pour la r√©cup√©rer sur un autre appareil (PC/Mobile).\r\n                            Le fichier sera stock√© dans <code>user_data/progress.json</code>.\r\n                        </p>\r\n\r\n                        <div className=\"flex gap-4\">\r\n                            <button \r\n                                onClick={async () => {\r\n                                    if(!confirm(\"Cela va √©craser la sauvegarde distante avec votre progression actuelle. Continuer ?\")) return;\r\n                                    const { saveFileContent } = await import('../utils/githubClient');\r\n                                    setIsLoadingReview(true);\r\n                                    try {\r\n                                        await saveFileContent(githubToken, 'skyreks00', 'permis-online-free', 'user_data/progress.json', JSON.stringify(progress, null, 2), 'chore: sync user progress');\r\n                                        alert(\"Progression sauvegard√©e dans le cloud ! ‚òÅÔ∏è‚úÖ\");\r\n                                    } catch(e) {\r\n                                        console.error(e);\r\n                                        alert(\"Erreur upload: \" + e.message);\r\n                                    } finally {\r\n                                        setIsLoadingReview(false);\r\n                                    }\r\n                                }}\r\n                                className=\"btn-secondary flex-1 flex items-center justify-center gap-2\"\r\n                            >\r\n                                üì§ Envoyer vers le Cloud\r\n                            </button>\r\n\r\n                            <button \r\n                                onClick={async () => {\r\n                                    if(!confirm(\"Cela va fusionner la sauvegarde distante avec votre appareil. Continuer ?\")) return;\r\n                                    const { fetchFileContent } = await import('../utils/githubClient');\r\n                                    setIsLoadingReview(true);\r\n                                    try {\r\n                                        const result = await fetchFileContent(githubToken, 'skyreks00', 'permis-online-free', 'user_data/progress.json');\r\n                                        if (!result) {\r\n                                            alert(\"Aucune sauvegarde trouv√©e dans le cloud.\");\r\n                                            return;\r\n                                        }\r\n                                        const remoteProgress = JSON.parse(result.content);\r\n                                        \r\n                                        // MERGE LOGIC: Last Modified Wins\r\n                                        const newProgress = { ...progress };\r\n                                        \r\n                                        // 1. Process Remote entries\r\n                                        Object.keys(remoteProgress).forEach(themeId => {\r\n                                            const r = remoteProgress[themeId];\r\n                                            const l = newProgress[themeId];\r\n                                            \r\n                                            // Case 1: Loop has entry, Local does not -> Take Remote\r\n                                            if (!l) {\r\n                                                newProgress[themeId] = r;\r\n                                            } else {\r\n                                                // Case 2: Both exist. Compare dates.\r\n                                                // Convert to dates (handle missing dates by defaulting to 0)\r\n                                                const rDate = r.date ? new Date(r.date).getTime() : 0;\r\n                                                const lDate = l.date ? new Date(l.date).getTime() : 0;\r\n                                                \r\n                                                // Allow small drift? No, strictly newer.\r\n                                                if (rDate > lDate) {\r\n                                                    console.log(`[Sync] Updating ${themeId}: Remote (${r.date}) > Local (${l.date})`);\r\n                                                    newProgress[themeId] = r;\r\n                                                }\r\n                                            }\r\n                                        });\r\n\r\n                                        // 2. Check for local entries not in remote? No, we keep local entries as is. \r\n                                        // This is a \"Merge Remote into Local\" operation.\r\n\r\n                                        localStorage.setItem('quizProgress', JSON.stringify(newProgress));\r\n                                        alert(\"Progression synchronis√©e (Derni√®re modification fait foi) ! R√©actualisez la page. üîÑ\");\r\n                                        window.location.reload();\r\n\r\n                                    } catch(e) {\r\n                                        console.error(e);\r\n                                        alert(\"Erreur download: \" + e.message);\r\n                                    } finally {\r\n                                        setIsLoadingReview(false);\r\n                                    }\r\n                                }}\r\n                                className=\"btn-primary flex-1 flex items-center justify-center gap-2\"\r\n                            >\r\n                                üì• R√©cup√©rer du Cloud\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n    );\r\n};\r\n\r\nexport default Profile;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\components\\QuestionCard.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'displayQuestion.correctAnswer' and 'onAnswer'. Either include them or remove the dependency array. If 'onAnswer' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":151,"column":6,"nodeType":"ArrayExpression","endLine":156,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [displayQuestion.correctAnswer, displayQuestion.id, displayQuestion.question, isCorrectionMode, onAnswer, savingState]","fix":{"range":[5030,5135],"text":"[displayQuestion.correctAnswer, displayQuestion.id, displayQuestion.question, isCorrectionMode, onAnswer, savingState]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'localErr' is defined but never used.","line":294,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":294,"endColumn":22}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useMemo, useRef, useState } from \"react\";\r\nimport { BookOpen, X, CheckCircle } from \"lucide-react\";\r\n\r\nconst QuestionCard = ({\r\n  question,\r\n  onAnswer,\r\n  currentIndex,\r\n  total,\r\n  instantFeedback,\r\n  autoPlayAudio,\r\n  onNext,\r\n  isLastQuestion,\r\n  fileName,\r\n  onQuestionUpdated,\r\n}) => {\r\n  const [selectedAnswer, setSelectedAnswer] = useState(null);\r\n  const [hasAnswered, setHasAnswered] = useState(false);\r\n  const [showExplanation, setShowExplanation] = useState(false);\r\n  const [freeformAnswer, setFreeformAnswer] = useState(\"\");\r\n  const [result, setResult] = useState(null); // 'correct' | 'incorrect' | null\r\n  const [timedOut, setTimedOut] = useState(false);\r\n  const MAX_TIME_MS = 30000; // temps maximum pour r√©pondre (ms)\r\n  const [timeLeft, setTimeLeft] = useState(MAX_TIME_MS);\r\n  const intervalRef = useRef(null);\r\n  const timeoutRef = useRef(null);\r\n  const answeredRef = useRef(false);\r\n\r\n  // Fix Logic States\r\n  const [isFixing, setIsFixing] = useState(false);\r\n  const [fixedQuestion, setFixedQuestion] = useState(null);\r\n  const [savingState, setSavingState] = useState(null); // 'saving', 'success', 'error'\r\n  const [saveMessage, setSaveMessage] = useState(\"\");\r\n\r\n  // Audio effect\r\n  const [voice, setVoice] = useState(null);\r\n\r\n  // Determine what to display: The Fixed version (if any) or the Original\r\n  const displayQuestion = fixedQuestion || question;\r\n  const isCorrectionMode = !!fixedQuestion;\r\n\r\n  useEffect(() => {\r\n    // Reset Fix UI when question changes\r\n    setIsFixing(false);\r\n    setFixedQuestion(null);\r\n    setSavingState(null);\r\n    setSaveMessage(\"\");\r\n  }, [question?.id]);\r\n\r\n  useEffect(() => {\r\n    const loadVoices = () => {\r\n      const voices = window.speechSynthesis.getVoices();\r\n      // Try to find a good French voice\r\n      // Priority: Google -> Microsoft -> any FR\r\n      const frVoices = voices.filter((v) => v.lang.startsWith(\"fr\"));\r\n      const best =\r\n        frVoices.find((v) => v.name.includes(\"Google\")) ||\r\n        frVoices.find((v) => v.name.includes(\"Microsoft\")) ||\r\n        frVoices.find((v) => v.name.includes(\"Natural\")) || // Edge 'Natural' voices\r\n        frVoices[0];\r\n      setVoice(best);\r\n    };\r\n\r\n    loadVoices();\r\n    window.speechSynthesis.onvoiceschanged = loadVoices;\r\n\r\n    return () => {\r\n      window.speechSynthesis.onvoiceschanged = null;\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (autoPlayAudio && displayQuestion) {\r\n      // Cancel previous speech\r\n      window.speechSynthesis.cancel();\r\n\r\n      // Construct text: Question ... Propositions\r\n      let textToRead = displayQuestion.question || \"\";\r\n      if (\r\n        displayQuestion.propositions &&\r\n        Array.isArray(displayQuestion.propositions)\r\n      ) {\r\n        const propsText = displayQuestion.propositions\r\n          .map((p) => `${p.letter}... ${p.text}`)\r\n          .join(\". \");\r\n        textToRead += `. ${propsText}`;\r\n      } else if (displayQuestion.type === \"yes_no\") {\r\n        textToRead += \". A... Oui. B... Non.\";\r\n      }\r\n\r\n      const utterance = new SpeechSynthesisUtterance(textToRead);\r\n      if (voice) utterance.voice = voice;\r\n      utterance.lang = \"fr-FR\";\r\n      utterance.rate = 1.0;\r\n      window.speechSynthesis.speak(utterance);\r\n    } else {\r\n      window.speechSynthesis.cancel();\r\n    }\r\n\r\n    // Cleanup on unmount or question change\r\n    return () => {\r\n      window.speechSynthesis.cancel();\r\n    };\r\n  }, [displayQuestion, autoPlayAudio, voice]); // Depend on displayQuestion\r\n\r\n  useEffect(() => {\r\n    // Reset interaction states when the DISPLAYED question changes (ID or content update)\r\n    setSelectedAnswer(null);\r\n    setHasAnswered(false);\r\n    setFreeformAnswer(\"\");\r\n    setResult(null);\r\n    setTimedOut(false);\r\n    setTimeLeft(MAX_TIME_MS);\r\n\r\n    // d√©marrer le compte √† rebours (seulement si pas en mode correction BLOQUANT)\r\n    clearInterval(intervalRef.current);\r\n    clearTimeout(timeoutRef.current);\r\n\r\n    // Bloquer seulement si on est en preview (savingState === null) ou erreur\r\n    // Si 'saving' ou 'success', on laisse le timer courir (Optimistic UI)\r\n    const isBlocking =\r\n      isCorrectionMode && (savingState === null || savingState === \"error\");\r\n\r\n    if (isBlocking) return;\r\n\r\n    const start = Date.now();\r\n    intervalRef.current = setInterval(() => {\r\n      const elapsed = Date.now() - start;\r\n      const remaining = Math.max(0, MAX_TIME_MS - elapsed);\r\n      setTimeLeft(remaining);\r\n    }, 100);\r\n\r\n    timeoutRef.current = setTimeout(() => {\r\n      if (!answeredRef.current) {\r\n        setTimedOut(true);\r\n        setSelectedAnswer(null);\r\n        setHasAnswered(true);\r\n        setResult(\"incorrect\");\r\n        onAnswer({\r\n          isCorrect: false,\r\n          userAnswer: null,\r\n          correctAnswer: displayQuestion.correctAnswer,\r\n          questionId: displayQuestion.id,\r\n        });\r\n      }\r\n    }, MAX_TIME_MS);\r\n\r\n    return () => {\r\n      clearInterval(intervalRef.current);\r\n      clearTimeout(timeoutRef.current);\r\n    };\r\n  }, [\r\n    displayQuestion?.id,\r\n    displayQuestion?.question,\r\n    isCorrectionMode,\r\n    savingState,\r\n  ]); // Added dependencies\r\n\r\n  useEffect(() => {\r\n    answeredRef.current = hasAnswered;\r\n  }, [hasAnswered]);\r\n\r\n  const normalizedCorrectAnswer = useMemo(() => {\r\n    const raw = displayQuestion?.correctAnswer ?? \"\";\r\n    return String(raw).trim();\r\n  }, [displayQuestion?.correctAnswer]);\r\n\r\n  const isFreeformCorrect = (rawAnswer) => {\r\n    const a = String(rawAnswer ?? \"\").trim();\r\n    const b = String(normalizedCorrectAnswer ?? \"\").trim();\r\n\r\n    // If both parse cleanly as numbers, compare numerically (handles \"4\" vs \"4,0\").\r\n    const an = Number(a.replace(\",\", \".\"));\r\n    const bn = Number(b.replace(\",\", \".\"));\r\n    if (!Number.isNaN(an) && !Number.isNaN(bn) && a !== \"\" && b !== \"\") {\r\n      return an === bn;\r\n    }\r\n\r\n    // Otherwise compare as normalized strings (case-insensitive).\r\n    return a.toUpperCase() === b.toUpperCase();\r\n  };\r\n\r\n  const handleAnswer = (answer) => {\r\n    if (hasAnswered) return;\r\n\r\n    setSelectedAnswer(answer);\r\n    setHasAnswered(true);\r\n    const isCorrect = answer === displayQuestion.correctAnswer;\r\n    setResult(isCorrect ? \"correct\" : \"incorrect\");\r\n    clearInterval(intervalRef.current);\r\n    clearTimeout(timeoutRef.current);\r\n    onAnswer({\r\n      isCorrect,\r\n      userAnswer: answer,\r\n      correctAnswer: displayQuestion.correctAnswer,\r\n      questionId: displayQuestion.id,\r\n    });\r\n  };\r\n\r\n  const handleFreeformSubmit = () => {\r\n    if (hasAnswered) return;\r\n    const value = String(freeformAnswer ?? \"\").trim();\r\n    if (!value) return;\r\n\r\n    const isCorrect = isFreeformCorrect(value);\r\n    setSelectedAnswer(value);\r\n    setHasAnswered(true);\r\n    setResult(isCorrect ? \"correct\" : \"incorrect\");\r\n    clearInterval(intervalRef.current);\r\n    clearTimeout(timeoutRef.current);\r\n    onAnswer({\r\n      isCorrect,\r\n      userAnswer: value,\r\n      correctAnswer: displayQuestion.correctAnswer,\r\n      questionId: displayQuestion.id,\r\n    });\r\n  };\r\n\r\n  const getButtonClass = (answer) => {\r\n    if (timedOut) return \"dimmed\";\r\n\r\n    if (hasAnswered && instantFeedback) {\r\n      // Mode correction directe\r\n      if (answer === displayQuestion.correctAnswer) return \"correct\";\r\n      if (\r\n        answer === selectedAnswer &&\r\n        selectedAnswer !== displayQuestion.correctAnswer\r\n      )\r\n        return \"incorrect\";\r\n      return \"dimmed\";\r\n    }\r\n\r\n    if (selectedAnswer == null) return \"\";\r\n    return answer === selectedAnswer ? \"selected\" : \"dimmed\";\r\n  };\r\n\r\n  // --- FIX LOGIC IMPORTS ---\r\n  // Ideally these would be at top, but we are inside function for tool simplicity.\r\n  // We will assume imports are added at top of file (I cannot inject imports easily with replace_file_content if I don't target top).\r\n  // Wait, I am replacing the whole component logic, so I NEED imports.\r\n  // Since I can't edit top of file in same tool call easily without context, I will ASSUME the user adds imports or I use dynamic imports.\r\n  // Actually, I should use `multi_replace` to add imports at top if I want to be clean.\r\n  // For now, I'll rely on global scope or assume `src/utils` are available.\r\n  // NO, I must fix imports. I'll do a separate tool call for imports or use `replace_file_content` carefully.\r\n  // I will add the imports to the TOP of the file in a separate step.\r\n\r\n  const handleFixQuestion = async () => {\r\n    const apiKey = localStorage.getItem(\"groq_api_key\");\r\n    if (!apiKey) {\r\n      alert(\"Veuillez ajouter votre cl√© API Groq dans le Profil.\");\r\n      return;\r\n    }\r\n\r\n    setIsFixing(true);\r\n    setSavingState(null);\r\n    try {\r\n      const { fixQuestionWithGroq } = await import(\"../utils/groq\");\r\n      // Always fix the ORIGINAL question, not the already fixed one (unless we want iterative fixes?)\r\n      // Let's stick to fixing the original 'question' prop.\r\n      const fixed = await fixQuestionWithGroq(question, apiKey);\r\n      setFixedQuestion(fixed);\r\n    } catch (e) {\r\n      console.error(e);\r\n      alert(\"Erreur lors de la correction : \" + e.message);\r\n    } finally {\r\n      setIsFixing(false);\r\n    }\r\n  };\r\n\r\n  const handleConfirmFix = async () => {\r\n    if (!fixedQuestion) return;\r\n    const { saveQuestionLocally } = await import(\"../utils/api\");\r\n    const { saveQuestionToGitHub, getUser } =\r\n      await import(\"../utils/githubClient\");\r\n\r\n    setSavingState(\"saving\"); // UI Unblocks HERE\r\n\r\n    const effectiveFileName = question.sourceFile || fileName;\r\n    console.log(\"[QuestionCard] Debug Fix:\", { \r\n        id: question.id, \r\n        sourceFile: question.sourceFile, \r\n        propFileName: fileName, \r\n        effective: effectiveFileName \r\n    });\r\n\r\n    if (!effectiveFileName) {\r\n        setSavingState(\"error\");\r\n        setSaveMessage(\"Erreur: Nom de fichier manquant\");\r\n        return;\r\n    }\r\n\r\n    // 1. Try Local Save (Silence error as backend might not be running)\r\n    try {\r\n      await saveQuestionLocally(effectiveFileName, question.id, fixedQuestion);\r\n    } catch (localErr) {\r\n      // Local save failed, backend likely offline\r\n    }\r\n\r\n    // 2. Try GitHub Save\r\n    const token = localStorage.getItem(\"github_token\");\r\n    if (!token) {\r\n      // Fallback: Copy to clipboard\r\n      navigator.clipboard.writeText(JSON.stringify(fixedQuestion, null, 2));\r\n      setSavingState(\"success\");\r\n      setSaveMessage(\"Copi√© (Pas de token GitHub)\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const user = await getUser(token);\r\n      const owner = \"skyreks00\";\r\n      const repo = \"permis-online-free\";\r\n      const path = `public/data/${effectiveFileName}`;\r\n      const commitMessage = `fix(content): correct question ${question.id} in ${effectiveFileName} (AI)`;\r\n\r\n      console.log(\"[handleConfirmFix] Saving question to GitHub...\");\r\n\r\n      const result = await saveQuestionToGitHub(\r\n        token,\r\n        owner,\r\n        repo,\r\n        path,\r\n        question.id,\r\n        fixedQuestion,\r\n        commitMessage,\r\n        user,\r\n      );\r\n\r\n      if (result.type === \"unchanged\") {\r\n        setSavingState(\"success\");\r\n        setSaveMessage(\"Aucun changement d√©tect√©\");\r\n        return;\r\n      }\r\n\r\n      setSavingState(\"success\");\r\n\r\n      if (result.type === \"pr\") {\r\n        setSaveMessage(\r\n          <a href={result.url} target=\"_blank\" rel=\"noreferrer\">\r\n            PR cr√©√©e !\r\n          </a>,\r\n        );\r\n      } else if (result.type === \"commit\") {\r\n        setSaveMessage(\r\n          <a href={result.url} target=\"_blank\" rel=\"noreferrer\">\r\n            Commit effectu√© !\r\n          </a>,\r\n        );\r\n      } else {\r\n        setSaveMessage(\"Sauvegard√© !\");\r\n      }\r\n\r\n      if (onQuestionUpdated) {\r\n        onQuestionUpdated(fixedQuestion);\r\n      }\r\n\r\n      setTimeout(() => {\r\n        setFixedQuestion(null);\r\n        setSavingState(null);\r\n      }, 2000);\r\n    } catch (ghErr) {\r\n      console.error(\"[handleConfirmFix] GitHub save error:\", ghErr);\r\n      setSavingState(\"error\");\r\n      setSaveMessage(\r\n        \"Erreur GitHub: \" + (ghErr.message || \"Probl√®me de sauvegarde\"),\r\n      );\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div\r\n      className={`question-card ${timedOut ? \"timed-out\" : \"\"} ${isCorrectionMode ? \"correction-mode\" : \"\"}`}\r\n      style={\r\n        isCorrectionMode\r\n          ? {\r\n              border: \"2px solid var(--warning)\",\r\n              boxShadow: \"0 0 15px rgba(255, 193, 7, 0.3)\",\r\n            }\r\n          : {}\r\n      }\r\n    >\r\n      <div className=\"question-header\">\r\n        <div className=\"question-progress\" aria-live=\"polite\">\r\n          Question {Math.min(currentIndex + 1, total)} / {total}\r\n          {isCorrectionMode && (\r\n            <span className=\"text-warning font-bold ml-2\">\r\n              ‚ú® CORRECTION SUGG√âR√âE\r\n            </span>\r\n          )}\r\n        </div>\r\n\r\n        {/* Fix Button / Actions */}\r\n        {localStorage.getItem(\"groq_api_key\") && !isCorrectionMode && (\r\n          <button\r\n            onClick={handleFixQuestion}\r\n            disabled={isFixing}\r\n            className=\"btn-ghost\"\r\n            style={{\r\n              fontSize: \"12px\",\r\n              padding: \"4px 8px\",\r\n              display: \"flex\",\r\n              alignItems: \"center\",\r\n              gap: \"4px\",\r\n            }}\r\n            title=\"Sugg√©rer une correction\"\r\n          >\r\n            {isFixing ? \"...\" : \"‚ú® Corriger\"}\r\n          </button>\r\n        )}\r\n      </div>\r\n\r\n      {/* Validation Controls (Only in Correction Mode) - Hide on success OR SAVING */}\r\n      {isCorrectionMode &&\r\n        (savingState === null || savingState === \"error\") && (\r\n          <div className=\"p-3 bg-surface-2 border-b border-warning mb-4 rounded flex flex-col gap-2\">\r\n            <div className=\"flex justify-between items-center\">\r\n              <span className=\"text-sm font-bold text-warning\">\r\n                Valider cette correction ?\r\n              </span>\r\n              <div className=\"flex gap-2\">\r\n                <button\r\n                  onClick={() => setFixedQuestion(null)}\r\n                  className=\"btn-ghost text-xs bg-surface-1\"\r\n                  disabled={savingState === \"saving\"}\r\n                >\r\n                  Annuler\r\n                </button>\r\n                <button\r\n                  onClick={handleConfirmFix}\r\n                  className=\"btn-primary text-xs bg-warning border-warning text-black\"\r\n                  disabled={savingState === \"saving\"}\r\n                >\r\n                  {savingState === \"saving\" ? \"Envoi...\" : \"Valider\"}\r\n                </button>\r\n              </div>\r\n            </div>\r\n            {savingState === \"error\" && (\r\n              <div className=\"text-danger text-xs\">{saveMessage}</div>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n      {/* Global Toast for Success */}\r\n      {(savingState === \"success\" || savingState === \"saving\") && (\r\n        <div className=\"toast-notification\">\r\n          <CheckCircle\r\n            size={24}\r\n            className={\r\n              savingState === \"success\" ? \"text-success\" : \"text-muted\"\r\n            }\r\n          />\r\n          <div>\r\n            <div className=\"font-bold text-sm\">\r\n              {savingState === \"success\"\r\n                ? \"Correction envoy√©e !\"\r\n                : \"Envoi en cours...\"}\r\n            </div>\r\n            {savingState === \"success\" && (\r\n              <div className=\"text-xs text-muted\">{saveMessage}</div>\r\n            )}\r\n            {savingState === \"saving\" && (\r\n              <div className=\"text-xs text-muted\">\r\n                Vous pouvez continuer √† jouer\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      <div\r\n        className=\"question-main\"\r\n        style={{\r\n          opacity:\r\n            isCorrectionMode &&\r\n            (savingState === null || savingState === \"error\")\r\n              ? 0.6\r\n              : 1,\r\n          filter:\r\n            isCorrectionMode &&\r\n            (savingState === null || savingState === \"error\")\r\n              ? \"grayscale(100%)\"\r\n              : \"none\",\r\n          transition: \"all 0.3s ease\",\r\n        }}\r\n      >\r\n        <div className=\"question-left\">\r\n          {displayQuestion.image ? (\r\n            <div className=\"question-image\">\r\n              <img src={displayQuestion.image} alt=\"Illustration\" />\r\n            </div>\r\n          ) : (\r\n            <div className=\"question-image placeholder\" />\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"question-right\">\r\n          <div className=\"question-text\">\r\n            <div>\r\n              {/* Use displayQuestion here */}\r\n              <div className=\"question-text-inner\">\r\n                {displayQuestion.question}\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"answers\">\r\n            {(displayQuestion.type === \"multiple_choice\" ||\r\n              displayQuestion.type === \"single_choice\") &&\r\n            displayQuestion.propositions ? (\r\n              displayQuestion.propositions.map((prop, idx) => {\r\n                // const isSelected = selectedAnswer === prop.letter; // Unused\r\n                // Only show check if instantFeedback is ON and it's the correct answer\r\n                // OR if it's the selected answer AND instantFeedback is ON (logic overlap, effectively: show on correct if feedback on)\r\n                // Actually, standard behavior:\r\n                // If feedback ON: Show valid check on Correct Answer.\r\n                // If feedback OFF: Do NOT show check.\r\n                const showCheck =\r\n                  hasAnswered &&\r\n                  instantFeedback &&\r\n                  prop.letter === displayQuestion.correctAnswer;\r\n                const isInteractionDisabled =\r\n                  isFixing ||\r\n                  hasAnswered ||\r\n                  (isCorrectionMode &&\r\n                    (savingState === null || savingState === \"error\"));\r\n\r\n                return (\r\n                  <button\r\n                    key={`${prop.letter}-${idx}`}\r\n                    className={`answer-btn ${getButtonClass(prop.letter)}`}\r\n                    onClick={() => handleAnswer(prop.letter)}\r\n                    disabled={isInteractionDisabled}\r\n                  >\r\n                    <div className=\"answer-key\">{prop.letter}</div>\r\n                    <div className=\"answer-text\">{prop.text}</div>\r\n                    {showCheck && (\r\n                      <CheckCircle size={20} className=\"answer-check\" />\r\n                    )}\r\n                  </button>\r\n                );\r\n              })\r\n            ) : displayQuestion.type === \"yes_no\" ? (\r\n              <>\r\n                {/* Logic for yes_no using displayQuestion... */}\r\n                {/* Simplified for brevity in this replace call, similar logic to original but using displayQuestion */}\r\n                <button\r\n                  className={`answer-btn ${getButtonClass(\"OUI\")}`}\r\n                  onClick={() => handleAnswer(\"OUI\")}\r\n                  disabled={\r\n                    isFixing ||\r\n                    hasAnswered ||\r\n                    (isCorrectionMode &&\r\n                      (savingState === null || savingState === \"error\"))\r\n                  }\r\n                >\r\n                  <div className=\"answer-key\">A</div>\r\n                  <div className=\"answer-text\">Oui</div>\r\n                  {hasAnswered &&\r\n                    instantFeedback &&\r\n                    displayQuestion.correctAnswer === \"OUI\" && (\r\n                      <CheckCircle size={20} className=\"answer-check\" />\r\n                    )}\r\n                </button>\r\n                <button\r\n                  className={`answer-btn ${getButtonClass(\"NON\")}`}\r\n                  onClick={() => handleAnswer(\"NON\")}\r\n                  disabled={\r\n                    isFixing ||\r\n                    hasAnswered ||\r\n                    (isCorrectionMode &&\r\n                      (savingState === null || savingState === \"error\"))\r\n                  }\r\n                >\r\n                  <div className=\"answer-key\">B</div>\r\n                  <div className=\"answer-text\">Non</div>\r\n                  {hasAnswered &&\r\n                    instantFeedback &&\r\n                    displayQuestion.correctAnswer === \"NON\" && (\r\n                      <CheckCircle size={20} className=\"answer-check\" />\r\n                    )}\r\n                </button>\r\n              </>\r\n            ) : (\r\n              <div className=\"number-wrap\">\r\n                {/* Freeform/Numeric using displayQuestion... */}\r\n                <div\r\n                  className={`number-field ${\r\n                    hasAnswered\r\n                      ? instantFeedback\r\n                        ? result === \"correct\"\r\n                          ? \"correct\"\r\n                          : \"incorrect\"\r\n                        : \"selected\"\r\n                      : \"\"\r\n                  }`}\r\n                >\r\n                  <input\r\n                    className=\"number-input\"\r\n                    type=\"text\"\r\n                    inputMode=\"numeric\"\r\n                    placeholder=\"Votre r√©ponse‚Ä¶\"\r\n                    value={freeformAnswer}\r\n                    disabled={\r\n                      isFixing ||\r\n                      hasAnswered ||\r\n                      (isCorrectionMode &&\r\n                        (savingState === null || savingState === \"error\"))\r\n                    }\r\n                    onChange={(e) => setFreeformAnswer(e.target.value)}\r\n                    onKeyDown={(e) => {\r\n                      if (e.key === \"Enter\") handleFreeformSubmit();\r\n                    }}\r\n                  />\r\n                  <button\r\n                    className=\"number-submit\"\r\n                    type=\"button\"\r\n                    onClick={handleFreeformSubmit}\r\n                    disabled={\r\n                      isFixing ||\r\n                      hasAnswered ||\r\n                      !String(freeformAnswer ?? \"\").trim() ||\r\n                      (isCorrectionMode &&\r\n                        (savingState === null || savingState === \"error\"))\r\n                    }\r\n                  >\r\n                    OK\r\n                  </button>\r\n                </div>\r\n                {/* Aucun retour imm√©diat sur la justesse de la r√©ponse */}\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          <div className=\"countdown desktop-countdown\" aria-hidden=\"true\">\r\n            {/* Countdown using timeLeft (reset in useEffect) */}\r\n            <div className=\"countdown-track\">\r\n              <div\r\n                className=\"countdown-fill\"\r\n                style={{\r\n                  width: `${Math.max(0, Math.min(100, (timeLeft / MAX_TIME_MS) * 100))}%`,\r\n                }}\r\n              />\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Navigation Buttons inside the right column */}\r\n      {hasAnswered && (\r\n        <div className=\"quiz-nav-buttons\">\r\n          {instantFeedback && question?.explanation && (\r\n            <button\r\n              onClick={() => setShowExplanation(true)}\r\n              className=\"btn-explanation\"\r\n            >\r\n              <BookOpen size={20} />\r\n              Explication\r\n            </button>\r\n          )}\r\n          <button type=\"button\" onClick={onNext} className=\"btn-next\">\r\n            {isLastQuestion ? \"Terminer\" : \"Suivant\"}\r\n          </button>\r\n        </div>\r\n      )}\r\n\r\n      {/* Popup Modal */}\r\n      {showExplanation && (\r\n        <div\r\n          style={{\r\n            position: \"fixed\",\r\n            top: 0,\r\n            left: 0,\r\n            width: \"100%\",\r\n            height: \"100%\",\r\n            background: \"rgba(0, 0, 0, 0.75)\",\r\n            zIndex: 9999,\r\n            display: \"flex\",\r\n            alignItems: \"center\",\r\n            justifyContent: \"center\",\r\n            padding: \"20px\",\r\n            backdropFilter: \"blur(4px)\",\r\n          }}\r\n          onClick={() => setShowExplanation(false)}\r\n        >\r\n          <div\r\n            style={{\r\n              background: \"var(--surface)\",\r\n              color: \"var(--foreground)\",\r\n              padding: \"24px\",\r\n              borderRadius: \"16px\",\r\n              maxWidth: \"600px\",\r\n              width: \"100%\",\r\n              maxHeight: \"90vh\",\r\n              overflowY: \"auto\",\r\n              position: \"relative\",\r\n              boxShadow: \"var(--shadow-lg)\",\r\n              border: \"1px solid var(--border)\",\r\n            }}\r\n            onClick={(e) => e.stopPropagation()}\r\n            className=\"animate-in fade-in zoom-in-95 duration-200\"\r\n          >\r\n            <button\r\n              onClick={() => setShowExplanation(false)}\r\n              className=\"text-muted hover-text-primary hover-scale\"\r\n              style={{\r\n                position: \"absolute\",\r\n                top: \"16px\",\r\n                right: \"16px\",\r\n                background: \"transparent\",\r\n                border: \"none\",\r\n                color: \"var(--muted-foreground)\",\r\n                cursor: \"pointer\",\r\n                padding: \"4px\",\r\n              }}\r\n            >\r\n              <X size={24} />\r\n            </button>\r\n            <div style={{ lineHeight: \"1.6\", fontSize: \"1.05rem\" }}>\r\n              {question.explanation\r\n                .replace(/^\\s*INFO\\W*PERMIS\\W*DE\\W*CONDUIRE\\W*/i, \"\") // Robust INFO removal\r\n                .replace(/^\\s*Signification\\W*/i, \"\") // Remove \"Signification\" + any non-word chars (: / - \\n)\r\n                .replace(/^\\s*Explication\\W*/i, \"\") // Remove \"Explication\" + any non-word chars\r\n                .replace(\r\n                  /^\\s*LE(?:√á|C)ON\\s*\\d+(?:\\s*[‚Äì\\-:]\\s*[^.\\n]*)?(?:[.\\n]\\s*)?/i,\r\n                  \"\",\r\n                ) // Remove \"LE√áON 1\" (+ opt title)\r\n                .trim()}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default QuestionCard;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\components\\Quiz.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'score' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":7,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":15,"suggestions":[{"messageId":"removeVar","data":{"varName":"score"},"fix":{"range":[326,331],"text":""},"desc":"Remove unused variable 'score'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'hasAnswered' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":8,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"hasAnswered"},"fix":{"range":[368,379],"text":""},"desc":"Remove unused variable 'hasAnswered'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'scoreRef' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":10,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":17,"suggestions":[{"messageId":"removeVar","data":{"varName":"scoreRef"},"fix":{"range":[485,512],"text":""},"desc":"Remove unused variable 'scoreRef'."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useRef, useState } from 'react';\r\nimport { ArrowLeft } from 'lucide-react';\r\nimport QuestionCard from './QuestionCard';\r\n\r\nconst Quiz = ({ questions, themeName, onFinish, onExit, instantFeedback, autoPlayAudio, fileName }) => {\r\n  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);\r\n  const [score, setScore] = useState(0);\r\n  const [hasAnswered, setHasAnswered] = useState(false);\r\n  const [questionsData, setQuestionsData] = useState(questions);\r\n  const scoreRef = useRef(0);\r\n  const answersRef = useRef([]);\r\n\r\n  const currentQuestion = questionsData[currentQuestionIndex];\r\n\r\n  const handleAnswer = ({ isCorrect, userAnswer, correctAnswer, questionId }) => {\r\n    console.log(\"DEBUG: handleAnswer called\", { currentQuestionIndex, questionId, isCorrect });\r\n\r\n    // 1. Update the answer in the ref\r\n    answersRef.current[currentQuestionIndex] = {\r\n      questionId,\r\n      userAnswer,\r\n      correctAnswer,\r\n      isCorrect,\r\n    };\r\n\r\n    console.log(\"DEBUG: answersRef updated\", JSON.stringify(answersRef.current));\r\n\r\n    // 2. Recalculate score entirely from the current answers state\r\n    const newScore = answersRef.current.filter(a => a && a.isCorrect).length;\r\n    console.log(\"DEBUG: newScore calculated\", newScore);\r\n\r\n    setScore(newScore);\r\n\r\n    setHasAnswered(true);\r\n  };\r\n\r\n  const handleNext = () => {\r\n    if (currentQuestionIndex < questionsData.length - 1) {\r\n      setCurrentQuestionIndex(currentQuestionIndex + 1);\r\n      setHasAnswered(false);\r\n    } else {\r\n      // Calculate final score properly from answersRef\r\n      const finalScore = answersRef.current.filter(a => a && a.isCorrect).length;\r\n      onFinish({ score: finalScore, answers: answersRef.current });\r\n    }\r\n  };\r\n\r\n  const handleQuestionUpdated = async (updatedQuestion) => {\r\n    const newQuestions = [...questionsData];\r\n    newQuestions[currentQuestionIndex] = updatedQuestion;\r\n    setQuestionsData(newQuestions);\r\n  };\r\n\r\n  return (\r\n    <div className=\"quiz\">\r\n      <div className=\"quiz-topbar\">\r\n        <button className=\"exit-btn\" onClick={onExit} style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>\r\n          <ArrowLeft size={18} /> Retour\r\n        </button>\r\n      </div>\r\n\r\n      <div className=\"quiz-content\">\r\n        <QuestionCard\r\n          key={`${currentQuestionIndex}-${currentQuestion?.id ?? 'q'}`}\r\n          title={themeName}\r\n          question={currentQuestion}\r\n          onAnswer={handleAnswer}\r\n          currentIndex={currentQuestionIndex}\r\n          total={questionsData.length}\r\n          instantFeedback={instantFeedback}\r\n          autoPlayAudio={autoPlayAudio}\r\n          onNext={handleNext}\r\n          isLastQuestion={currentQuestionIndex === questionsData.length - 1}\r\n          fileName={fileName}\r\n          onQuestionUpdated={handleQuestionUpdated}\r\n        />\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Quiz;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\components\\Results.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'formatAnswer' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":32,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"formatAnswer"},"fix":{"range":[1785,2233],"text":""},"desc":"Remove unused variable 'formatAnswer'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { Trophy, ThumbsUp, Award, Target, PartyPopper, CheckCircle, ArrowLeft } from 'lucide-react';\r\n\r\nconst Results = ({ score, total, questions = [], answers = [], showReview = false, onRestart, onBackToThemes, isExamMode, isReviewOnly = false, customErrorItems = null, onBackToProfile }) => {\r\n  const percentage = total > 0 ? Math.round((score / total) * 100) : 0;\r\n\r\n  const getResultMessage = () => {\r\n    if (isReviewOnly) return { icon: <Target size={48} className=\"text-primary\" />, text: 'Mode R√©vision', tone: 'info' };\r\n\r\n    if (isExamMode) {\r\n      const incorrect = total - score;\r\n      if (incorrect >= 9) {\r\n        return { icon: <Target size={48} className=\"text-danger\" />, text: '√âCHEC - 9 fautes ou plus', tone: 'danger' };\r\n      }\r\n      return { icon: <Trophy size={48} className=\"text-success\" />, text: 'R√âUSSI !', tone: 'success' };\r\n    }\r\n\r\n    if (percentage >= 90) return { icon: <Trophy size={48} className=\"text-success\" />, text: 'Excellent !', tone: 'success' };\r\n    if (percentage >= 75) return { icon: <ThumbsUp size={48} className=\"text-success\" />, text: 'Tr√®s bien !', tone: 'success' };\r\n    if (percentage >= 50) return { icon: <Award size={48} className=\"text-warning\" />, text: 'Pas mal !', tone: 'warn' };\r\n    return { icon: <Target size={48} className=\"text-danger\" />, text: 'Continue √† t\\'entra√Æner !', tone: 'danger' };\r\n  };\r\n\r\n  const result = getResultMessage();\r\n\r\n  // Build error list for review\r\n  // If customErrorItems is provided (from Profile review), use it.\r\n  // Otherwise, use fallback logic (mapping by index - legacy).\r\n  const errorItems = customErrorItems || (questions || []).map((q, idx) => ({ q, a: answers?.[idx], idx }))\r\n    .filter(({ a }) => a && a.isCorrect === false);\r\n\r\n  const formatAnswer = (q, value) => {\r\n    if (value == null || value === undefined || value === '') return '‚Äî';\r\n    // yes/no mapping\r\n    if (value === 'OUI') return 'Oui';\r\n    if (value === 'NON') return 'Non';\r\n    // propositions mapping\r\n    if (Array.isArray(q?.propositions)) {\r\n      const item = q.propositions.find(p => p.letter === value);\r\n      if (item) return `${item.letter}. ${item.text}`;\r\n    }\r\n    return String(value);\r\n  };\r\n\r\n  const cleanExplanation = (text) => {\r\n    if (!text) return '';\r\n    return text\r\n      .replace(/^\\s*INFO\\W*PERMIS\\W*DE\\W*CONDUIRE\\W*/i, '')\r\n      .replace(/^\\s*Signification\\W*/i, '')\r\n      .replace(/^\\s*Explication\\W*/i, '')\r\n      .replace(/^\\s*LE(?:√á|C)ON\\s*\\d+(?:\\s*[‚Äì\\-:]\\s*[^.\\n]*)?(?:[.\\n]\\s*)?/i, '')\r\n      .trim();\r\n  };\r\n\r\n  return (\r\n    <div className=\"results container\" style={{ textAlign: 'center' }}>\r\n        \r\n      {!isReviewOnly ? (\r\n        <>\r\n            <div style={{ margin: '20px 0', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '16px' }}>\r\n                {result.icon}\r\n                <h1 style={{ margin: 0 }}>{result.text}</h1>\r\n            </div>\r\n\r\n            <p style={{ fontSize: '1.2rem', marginBottom: '20px' }}>\r\n                Score: <strong>{score}</strong> / {total} ({percentage}%)\r\n            </p>\r\n\r\n            <p>\r\n                Correctes: <strong>{score}</strong> | Incorrectes: <strong>{total - score}</strong>\r\n            </p>\r\n\r\n            <div className=\"results-actions\" style={{ justifyContent: 'center' }}>\r\n                <button type=\"button\" className=\"btn-primary\" onClick={onRestart}>\r\n                Recommencer\r\n                </button>\r\n                <button type=\"button\" onClick={onBackToThemes}>\r\n                Choisir un autre th√®me\r\n                </button>\r\n            </div>\r\n        </>\r\n      ) : (\r\n        <div style={{ margin: '20px 0', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '16px' }}>\r\n            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>\r\n                <Target size={32} className=\"text-primary\" />\r\n                <h1 style={{ margin: 0 }}>R√©vision des erreurs</h1>\r\n            </div>\r\n            <p className=\"text-muted\">\r\n                Voici les points √† retravailler. Prenez le temps de lire les explications.\r\n            </p>\r\n            <button onClick={onBackToProfile} className=\"btn-secondary flex items-center gap-2\">\r\n                <ArrowLeft size={20} /> Retour au profil\r\n            </button>\r\n        </div>\r\n      )}\r\n\r\n      {(showReview || isReviewOnly) && (\r\n        <div style={{ marginTop: '30px', textAlign: 'left', display: 'flex', flexDirection: 'column', gap: '32px' }}>\r\n          {errorItems.length === 0 ? (\r\n            <div className=\"card\" style={{ padding: '32px', textAlign: 'center' }}>\r\n              <p className=\"muted\" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', fontSize: '1.2rem', margin: 0 }}>\r\n                <PartyPopper size={24} /> Aucune erreur √† r√©viser. Bravo !\r\n              </p>\r\n               {isReviewOnly && (\r\n                   <button onClick={onBackToProfile} className=\"btn-primary mt-4\">\r\n                       Retour au profil\r\n                   </button>\r\n               )}\r\n            </div>\r\n          ) : (\r\n            errorItems.map(({ q, a, idx }) => (\r\n              <div className=\"question-card card\" key={`${q.id}-${idx}`}>\r\n                <div className=\"question-header\">\r\n                  <div className=\"question-progress\" style={{ color: 'var(--danger)' }}>\r\n                    Question {idx + 1}\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"question-main\">\r\n                  <div className=\"question-left\">\r\n                    {q.image ? (\r\n                      <div className=\"question-image\">\r\n                        <img src={q.image} alt=\"Illustration\" />\r\n                      </div>\r\n                    ) : (\r\n                      <div className=\"question-image placeholder\" />\r\n                    )}\r\n                  </div>\r\n\r\n                  <div className=\"question-right\">\r\n                    <div className=\"question-text\">\r\n                      <div className=\"question-text-inner\">{q.question}</div>\r\n                    </div>\r\n\r\n                    <div className=\"answers\">\r\n                      {q.type === 'multiple_choice' && q.propositions ? (\r\n                        q.propositions.map((prop) => {\r\n                          const isCorrect = prop.letter === q.correctAnswer;\r\n                          const isSelected = a?.userAnswer === prop.letter;\r\n                          let btnClass = '';\r\n                          if (isCorrect) btnClass = 'correct';\r\n                          else if (isSelected) btnClass = 'incorrect';\r\n                          else btnClass = 'dimmed';\r\n\r\n                          return (\r\n                            <button\r\n                              key={prop.letter}\r\n                              className={`answer-btn ${btnClass}`}\r\n                              disabled\r\n                              style={{ opacity: 1, cursor: 'default' }}\r\n                            >\r\n                              <div className=\"answer-key\">{prop.letter}</div>\r\n                              <div className=\"answer-text\">{prop.text}</div>\r\n                              {isCorrect && <CheckCircle size={20} className=\"text-success\" />}\r\n                            </button>\r\n                          );\r\n                        })\r\n                      ) : q.type === 'yes_no' ? (\r\n                        <>\r\n                          {['OUI', 'NON'].map((val, i) => {\r\n                            const letter = i === 0 ? 'A' : 'B';\r\n                            const label = i === 0 ? 'Oui' : 'Non';\r\n                            const isCorrect = val === q.correctAnswer;\r\n                            const isSelected = a?.userAnswer === val;\r\n                            let btnClass = '';\r\n                            if (isCorrect) btnClass = 'correct';\r\n                            else if (isSelected) btnClass = 'incorrect';\r\n                            else btnClass = 'dimmed';\r\n\r\n                            return (\r\n                              <button\r\n                                key={val}\r\n                                className={`answer-btn ${btnClass}`}\r\n                                disabled\r\n                                style={{ opacity: 1, cursor: 'default' }}\r\n                              >\r\n                                <div className=\"answer-key\">{letter}</div>\r\n                                <div className=\"answer-text\">{label}</div>\r\n                                {isCorrect && <CheckCircle size={20} className=\"text-success\" />}\r\n                              </button>\r\n                            );\r\n                          })}\r\n                        </>\r\n                      ) : (\r\n                        <div className=\"p-4 border rounded bg-surface-2\">\r\n                          <p><strong>Votre r√©ponse:</strong> {a?.userAnswer || '‚Äî'}</p>\r\n                          <p><strong>R√©ponse attendue:</strong> {q.correctAnswer}</p>\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                {q.explanation && (\r\n                  <div className=\"explanation animate-fade-in\">\r\n                    <div className=\"explanation-title\" style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>\r\n                      <Award size={20} className=\"text-primary\" />\r\n                      Conseil\r\n                    </div>\r\n                    <div className=\"explanation-text\" style={{ fontSize: '1.05rem', lineHeight: 1.6 }}>\r\n                      {cleanExplanation(q.explanation)}\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            ))\r\n          )}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Results;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\components\\ThemeSelector.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\components\\TopControls.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\data\\htmlLessons.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\data\\lessons.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\data\\order.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\main.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\pages\\HomePage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\pages\\LessonPage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\pages\\ProfilePage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\pages\\QuizPage.jsx","messages":[{"ruleId":null,"nodeType":null,"fatal":true,"severity":2,"message":"Parsing error: Identifier 'location' has already been declared","line":20,"column":11}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":1,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { useParams, useNavigate, useLocation } from 'react-router-dom';\r\nimport Quiz from '../components/Quiz';\r\nimport TopControls from '../components/TopControls';\r\nimport { loadThemeQuestions } from '../utils/contentLoader';\r\n\r\nconst QuizPage = ({\r\n    sections,\r\n    onFinishQuiz, // App callback to save progress\r\n    onPatchProgress, // New callback to patch progress (for reviews)\r\n    instantFeedback,\r\n    autoPlayAudio,\r\n    toggleTheme,\r\n    isDarkMode,\r\n    onMistakesCorrected\r\n}) => {\r\n    const { themeId } = useParams();\r\n    const location = useLocation();\r\n    const navigate = useNavigate();\r\n    const location = useLocation();\r\n    const [questions, setQuestions] = useState([]);\r\n    const [theme, setTheme] = useState(null);\r\n    const [isLoading, setIsLoading] = useState(true);\r\n    const [error, setError] = useState(null);\r\n\r\n    useEffect(() => {\r\n        const loadData = async () => {\r\n            // Check if questions are passed via state (e.g. for Mistake Quiz)\r\n            if (location.state?.questions && location.state?.theme) {\r\n                setTheme(location.state.theme);\r\n                setQuestions(location.state.questions);\r\n                setIsLoading(false);\r\n                return;\r\n            }\r\n\r\n            // If sections are not loaded yet (refresh case), wait.\r\n            // App.jsx will trigger a re-render when sections are updated.\r\n            if (!sections || sections.length === 0) {\r\n                return;\r\n            }\r\n\r\n            setIsLoading(true);\r\n            setError(null);\r\n\r\n<<<<<<< HEAD\r\n            // Check if we have custom questions passed via navigation state (e.g. for Review/Mistakes)\r\n            if (location.state && location.state.questions) {\r\n                setTheme({ \r\n                    id: 'review', \r\n                    name: location.state.title || 'R√©vision des erreurs', \r\n                    file: null \r\n                });\r\n                setQuestions(location.state.questions);\r\n                setIsLoading(false);\r\n                return;\r\n            }\r\n\r\n=======\r\n>>>>>>> 9f4b4031ef3de6b9da275ca6f157967228dda77b\r\n            // Find theme in sections\r\n            let foundTheme = null;\r\n            if (themeId === 'examen_B') {\r\n                foundTheme = { id: 'examen_B', name: 'Examen Blanc', file: 'examen_B.json' };\r\n            } else {\r\n                for (const section of sections) {\r\n                    const items = section.items || section.themes || [];\r\n                    const t = items.find(t => t.id === themeId);\r\n                    if (t) {\r\n                        foundTheme = t;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (!foundTheme) {\r\n                setError(\"Th√®me non trouv√©\");\r\n                setIsLoading(false);\r\n                return;\r\n            }\r\n\r\n            setTheme(foundTheme);\r\n\r\n            try {\r\n                // Load questions\r\n                const data = await loadThemeQuestions(foundTheme.file);\r\n                let loaded = data.questions || [];\r\n\r\n                if (loaded.length === 0) {\r\n                    // Fallback\r\n                    const base = import.meta.env.BASE_URL || '/';\r\n                    const res = await fetch(`${base}data/${foundTheme.file}`);\r\n                    const json = await res.json();\r\n                    loaded = json.questions || [];\r\n                }\r\n\r\n                // Shuffle\r\n                const shuffled = [...loaded].sort(() => Math.random() - 0.5);\r\n\r\n                if (foundTheme.id.includes('examen')) {\r\n                    setQuestions(shuffled.slice(0, 50));\r\n                } else {\r\n                    setQuestions(shuffled);\r\n                }\r\n            } catch (err) {\r\n                console.error(\"Failed to load questions\", err);\r\n                setError(\"Erreur de chargement des questions\");\r\n            } finally {\r\n                setIsLoading(false);\r\n            }\r\n        };\r\n\r\n<<<<<<< HEAD\r\n        if (sections.length > 0 || (location.state && location.state.questions)) {\r\n            loadData();\r\n        }\r\n    }, [themeId, sections, location.state]);\r\n=======\r\n        loadData();\r\n    }, [themeId, sections]);\r\n>>>>>>> 9f4b4031ef3de6b9da275ca6f157967228dda77b\r\n\r\n    const handleFinish = (payload) => {\r\n        // Notify App to save progress\r\n        const score = typeof payload === 'number' ? payload : payload.score;\r\n        const answers = typeof payload === 'object' ? payload.answers : [];\r\n\r\n        // We delegate the saving logic to App via onFinishQuiz\r\n<<<<<<< HEAD\r\n        // But App needs to know which theme and how many questions\r\n        \r\n        // Check if we are in a review mode (custom questions via state)\r\n        // If so, we likely DON'T want to save this as a new attempt for the theme, \r\n        // effectively treating it as a practice run.\r\n        const isReviewMode = location.state && location.state.isReview;\r\n\r\n        if (onFinishQuiz && !isReviewMode) {\r\n            // Fix: Pass payload.answers to saveProgress so they are stored in localStorage\r\n            onFinishQuiz(theme.id, score, questions.length, payload.answers);\r\n        } else if (isReviewMode && onPatchProgress) {\r\n            // Processing review results to patch original progress\r\n            const answers = payload.answers || []; // [{ questionId, isCorrect, ... }]\r\n            const correctAnswers = answers.filter(a => a && a.isCorrect);\r\n\r\n            if (correctAnswers.length > 0) {\r\n                // We need to group by themeId (handleReviewAll involves multiple themes)\r\n                // The question objects in 'questions' state have 'originalThemeId' attached\r\n                \r\n                // Map questionId -> originalThemeId\r\n                const questionThemeMap = {};\r\n                questions.forEach(q => {\r\n                    if (q.originalThemeId) {\r\n                        questionThemeMap[q.id] = q.originalThemeId;\r\n                    }\r\n                });\r\n\r\n                // Group correct answers by theme\r\n                const updatesByTheme = {}; // { themeId: [answerObjects] }\r\n                \r\n                correctAnswers.forEach(ans => {\r\n                    const tId = questionThemeMap[ans.questionId];\r\n                    if (tId) {\r\n                        if (!updatesByTheme[tId]) updatesByTheme[tId] = [];\r\n                        updatesByTheme[tId].push(ans);\r\n                    }\r\n                });\r\n\r\n                // Dispatch updates\r\n                Object.keys(updatesByTheme).forEach(tId => {\r\n                    onPatchProgress(tId, updatesByTheme[tId]);\r\n                });\r\n            }\r\n=======\r\n        if (onFinishQuiz && theme) {\r\n            onFinishQuiz(theme.id, score, questions.length, answers);\r\n        }\r\n\r\n        // Check for corrections in revision mode\r\n        if (onMistakesCorrected && theme && theme.id.includes('erreurs')) {\r\n            const corrections = answers\r\n                .filter(a => a.isCorrect)\r\n                .map(a => {\r\n                    const q = questions.find(q => q.id === a.questionId);\r\n                    return q && q.sourceThemeId ? { themeId: q.sourceThemeId, questionId: q.id } : null;\r\n                })\r\n                .filter(Boolean);\r\n\r\n            console.log(\"QuizPage: Generated corrections:\", corrections); // DEBUG LOG\r\n\r\n            if (corrections.length > 0) {\r\n                console.log(\"QuizPage: Calling onMistakesCorrected\"); // DEBUG LOG\r\n                onMistakesCorrected(corrections);\r\n            } else {\r\n                console.log(\"QuizPage: No corrections generated (maybe sourceThemeId missing or no correct answers?)\");\r\n            }\r\n        } else {\r\n            console.log(\"QuizPage: Not triggering corrections. onMistakesCorrected:\", !!onMistakesCorrected, \"theme:\", theme);\r\n>>>>>>> 9f4b4031ef3de6b9da275ca6f157967228dda77b\r\n        }\r\n\r\n        // Navigate to results\r\n        // If it was a review, we might want to differentiate the results page too?\r\n        navigate('/resultats', {\r\n            state: {\r\n                results: {\r\n                    correct: score,\r\n                    incorrect: questions.length - score,\r\n                    score: score,\r\n                    answers: answers\r\n                },\r\n                questions: questions,\r\n                total: questions.length,\r\n<<<<<<< HEAD\r\n                isExamMode: theme.id.includes('examen'),\r\n                // If it was a review, results page can perhaps show \"R√©vision termin√©e\"\r\n                isReviewSession: isReviewMode\r\n=======\r\n                isExamMode: theme && theme.id.includes('examen'),\r\n                themeId: theme ? theme.id : null\r\n>>>>>>> 9f4b4031ef3de6b9da275ca6f157967228dda77b\r\n            }\r\n        });\r\n    };\r\n\r\n    // Show loading state if we are fetching data OR if we are waiting for sections (refresh case)\r\n    if (isLoading || !sections || sections.length === 0) {\r\n        return <div className=\"p-8 text-center\"><span className=\"loading loading-spinner loading-lg\"></span><br />Chargement du quiz...</div>;\r\n    }\r\n\r\n    if (error) {\r\n        return <div className=\"p-8 text-center text-error\">{error} <br /><button onClick={() => navigate('/')} className=\"btn mt-4\">Retour</button></div>;\r\n    }\r\n\r\n    return (\r\n        <>\r\n            <TopControls\r\n                showProfileButton={false}\r\n                toggleTheme={toggleTheme}\r\n                isDarkMode={isDarkMode}\r\n            />\r\n            {theme && questions.length > 0 && (\r\n                <Quiz\r\n                    questions={questions}\r\n                    themeName={theme.name}\r\n                    onFinish={handleFinish}\r\n                    onExit={() => navigate('/')}\r\n                    instantFeedback={instantFeedback && !theme.id.includes('examen')}\r\n                    autoPlayAudio={autoPlayAudio}\r\n                    fileName={theme.file}\r\n                />\r\n            )}\r\n        </>\r\n    );\r\n};\r\n\r\nexport default QuizPage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\pages\\ResultsPage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\utils\\api.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\utils\\contentLoader.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":43,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":43,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Content Loader Utility\r\n * Loads question data from local public/data folder\r\n * Falls back to GitHub if needed (or vice versa, but for local dev/preview we want local data)\r\n */\r\n\r\nconst GITHUB_RAW_BASE = 'https://raw.githubusercontent.com/skyreks00/permis-online-free/main/public/data';\r\n\r\n/**\r\n * Loads JSON content from GitHub or local data as fallback\r\n * @param {string} filename - The filename to load (e.g., 'themes.json')\r\n * @param {object|null} fallbackData - Optional fallback data if fetch fails\r\n * @returns {Promise<object>} - The loaded JSON data\r\n */\r\nexport const loadFromGitHub = async (filename, fallbackData = null) => {\r\n    const cacheBuster = Date.now();\r\n    const url = `${GITHUB_RAW_BASE}/${filename}?_=${cacheBuster}`;\r\n\r\n    try {\r\n        console.log(`[ContentLoader] Fetching ${filename} from GitHub...`);\r\n        const response = await fetch(url);\r\n\r\n        if (!response.ok) {\r\n            throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n        }\r\n\r\n        const data = await response.json();\r\n        console.log(`[ContentLoader] Successfully loaded ${filename} from GitHub`);\r\n        return data;\r\n    } catch (error) {\r\n        console.warn(`[ContentLoader] Failed to load ${filename} from GitHub:`, error.message);\r\n        console.log(`[ContentLoader] Trying local fallback for ${filename}...`);\r\n    }\r\n\r\n    try {\r\n        console.log(`[ContentLoader] Fetching ${filename} from local data...`);\r\n        const response = await fetch(`data/${filename}`);\r\n        if (response.ok) {\r\n            const data = await response.json();\r\n            console.log(`[ContentLoader] Successfully loaded ${filename} from local data`);\r\n            return data;\r\n        }\r\n    } catch (e) {\r\n        console.warn(`[ContentLoader] Local fetch also failed for ${filename}`);\r\n    }\r\n\r\n    if (fallbackData) {\r\n        console.log(`[ContentLoader] Using bundled fallback for ${filename}`);\r\n        return fallbackData;\r\n    }\r\n\r\n    throw new Error(`Failed to load ${filename} from all sources`);\r\n};\r\n\r\n/**\r\n * Loads a theme's question file from GitHub\r\n * @param {string} themeFile - The theme filename (e.g., '7_les_pietons.json')\r\n * @param {object|null} fallbackData - Optional bundled questions as fallback\r\n * @returns {Promise<object>} - The theme data with questions\r\n */\r\nexport const loadThemeQuestions = async (themeFile, fallbackData = null) => {\r\n    return loadFromGitHub(themeFile, fallbackData);\r\n};\r\n\r\n/**\r\n * Loads the themes index file from GitHub\r\n * @param {object|null} fallbackData - Optional bundled themes as fallback\r\n * @returns {Promise<object>} - The themes index data\r\n */\r\nexport const loadThemesIndex = async (fallbackData = null) => {\r\n    return loadFromGitHub('themes.json', fallbackData);\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\utils\\gemini.js","messages":[{"ruleId":"no-dupe-keys","severity":2,"message":"Duplicate key 'model'.","line":121,"column":7,"nodeType":"ObjectExpression","messageId":"unexpected","endLine":121,"endColumn":12}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { GoogleGenAI } from \"@google/genai\";\r\n\r\n/**\r\n * Fixes a question using Gemini 3 Flash Preview.\r\n * Uses a local proxy if available (to avoid CORS), otherwise falls back to direct SDK call.\r\n * @param {object} question - The question object to fix\r\n * @param {string} apiKey - The Gemini API Key\r\n * @returns {Promise<object>} - The fixed question object\r\n */\r\nexport const fixQuestionWithGemini = async (question, apiKey) => {\r\n  if (!apiKey) throw new Error(\"API Key is missing\");\r\n\r\n  const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';\r\n\r\n  // 1. Try Local Proxy (Preferred for localhost to bypass CORS)\r\n  if (isLocal) {\r\n    try {\r\n      console.log(\"Attempting Local Proxy...\");\r\n      const response = await fetch('http://localhost:3001/api/fix-question', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ question, apiKey })\r\n      });\r\n\r\n      if (response.ok) {\r\n        return await response.json();\r\n      } else {\r\n        console.warn(\"Proxy failed, falling back to direct SDK:\", response.statusText);\r\n      }\r\n    } catch (err) {\r\n      console.warn(\"Proxy unreachable, falling back to direct SDK:\", err);\r\n    }\r\n  }\r\n\r\n  // 2. Direct SDK Call (Fallback / Production)\r\n  console.log(\"Attempting Direct SDK Call (generateContent)...\");\r\n  const client = new GoogleGenAI({ apiKey: apiKey });\r\n\r\n  const prompt = `\r\n    You are an expert specific to driving license questions.\r\n    Your task is to FIX the following JSON question object.\r\n    \r\n    RULES:\r\n    1. **Fix Typos & Grammar**: Correct any spelling or grammatical errors in 'question', 'propositions', and 'explanation'.\r\n    2. **Start** with a valid JSON structure.\r\n    3. **Three Supported Question Types**:\r\n       - \"multiple_choice\" (Standard question with options A, B, C... used for BOTH single and multiple valid answers)\r\n       - \"true_false\" (Binary question, Oui/Non)\r\n       - \"number\" (Open numeric field, NO propositions)\r\n       \r\n       *CRITICAL RULES FOR TYPES:*\r\n       - If the question has options/propositions (A, B, C), the type MUST be \"multiple_choice\".\r\n       - NEVER use \"single_choice\" (it does not exist in the system).\r\n       - NEVER use \"number\" type if there are possibilities/propositions.\r\n       - ONLY use \"number\" type if the user must type a value and 'correctAnswer' is a raw number (e.g. \"50\", \"0.5\").\r\n    4. **Propositions Structure**:\r\n       - Must be an array of objects: [{ \"letter\": \"A\", \"text\": \"...\" }, { \"letter\": \"B\", \"text\": \"...\" }]\r\n       - Do NOT merge propositions into the question text.\r\n       - Ensure \"answer\" field matches the letters (e.g., \"A\" or \"AC\").\r\n    5. **JSON Only**: Output ONLY valid JSON.\r\n\r\n    EXAMPLES:\r\n\r\n    Type: \"multiple_choice\" (Multiple valid answers)\r\n    {\r\n      \"type\": \"multiple_choice\",\r\n      \"question\": \"Le panneau indique une vitesse limit√©e √† ... (A) ... ou la fin d'une zone 30 ... (B) ...\",\r\n      \"propositions\": [\r\n        { \"letter\": \"A\", \"text\": \"50 km/h\" },\r\n        { \"letter\": \"B\", \"text\": \"Oui\" },\r\n        { \"letter\": \"C\", \"text\": \"Non\" }\r\n      ],\r\n      \"correctAnswer\": \"AC\"\r\n    }\r\n\r\n    Type: \"true_false\"\r\n    {\r\n      \"type\": \"true_false\",\r\n      \"question\": \"Je peux d√©passer ce v√©hicule par la droite ?\",\r\n      \"propositions\": [\r\n        { \"letter\": \"A\", \"text\": \"Oui\" },\r\n        { \"letter\": \"B\", \"text\": \"Non\" }\r\n      ],\r\n      \"correctAnswer\": \"B\"\r\n    }\r\n\r\n    Type: \"multiple_choice\" (Single valid answer - MUST BE \"multiple_choice\")\r\n    {\r\n      \"type\": \"multiple_choice\",\r\n      \"question\": \"Quelle est la vitesse maximale autoris√©e ?\",\r\n      \"propositions\": [\r\n        { \"letter\": \"A\", \"text\": \"30 km/h\" },\r\n        { \"letter\": \"B\", \"text\": \"50 km/h\" },\r\n        { \"letter\": \"C\", \"text\": \"70 km/h\" }\r\n      ],\r\n      \"correctAnswer\": \"B\"\r\n    }\r\n\r\n    Type: \"multiple_choice\" (Numeric Answers - MUST BE \"multiple_choice\")\r\n    {\r\n      \"type\": \"multiple_choice\",\r\n      \"question\": \"Quel est le poids maximum ?\",\r\n      \"propositions\": [\r\n         { \"letter\": \"A\", \"text\": \"500 kg\" },\r\n         { \"letter\": \"B\", \"text\": \"1000 kg\" }\r\n      ],\r\n      \"correctAnswer\": \"A\"\r\n    }\r\n\r\n    Original Question to Fix:\r\n    ${JSON.stringify(question, null, 2)}\r\n  `;\r\n\r\n  try {\r\n    // Switching to generateContent for better CORS support in browser\r\n    const response = await client.models.generateContent({\r\n      model: 'gemini-2.0-flash', // Fallback to 2.0 Flash for stability on direct calls, or try 'gemini-3-flash-preview'\r\n      // Let's try to stick to the requested model if possible, but 'gemini-3-flash-preview' might be interactions-only?\r\n      // Let's try 3 first.\r\n      model: 'gemini-3-flash-preview',\r\n      contents: prompt,\r\n      config: {\r\n        responseMimeType: 'application/json'\r\n      }\r\n    });\r\n\r\n    // In new SDK, .text is a property, not a function\r\n    const text = response.text;\r\n\r\n    if (!text) {\r\n      throw new Error(\"No text in response\");\r\n    }\r\n\r\n    console.log(\"Gemini Raw Response:\", text);\r\n\r\n    const jsonString = text.replace(/```json/g, '').replace(/```/g, '').trim();\r\n    const result = JSON.parse(jsonString);\r\n\r\n    // If Gemini returns an array (common behavior), take the first item\r\n    if (Array.isArray(result)) {\r\n      return result[0];\r\n    }\r\n    return result;\r\n\r\n  } catch (error) {\r\n    console.error(\"Gemini Direct SDK Error:\", error);\r\n    alert(\"Attention: Impossible de contacter Gemini directement depuis GitHub (CORS). Cette fonctionnalit√© n√©cessite le proxy local (node server.js).\");\r\n    throw error;\r\n  }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\utils\\githubClient.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'user' is defined but never used.","line":38,"column":108,"nodeType":"Identifier","messageId":"unusedVar","endLine":38,"endColumn":112,"suggestions":[{"messageId":"removeVar","data":{"varName":"user"},"fix":{"range":[1261,1267],"text":""},"desc":"Remove unused variable 'user'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'providedSha' is assigned a value but never used.","line":101,"column":86,"nodeType":"Identifier","messageId":"unusedVar","endLine":101,"endColumn":97,"suggestions":[{"messageId":"removeVar","data":{"varName":"providedSha"},"fix":{"range":[3453,3473],"text":""},"desc":"Remove unused variable 'providedSha'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":208,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":208,"endColumn":19}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * GitHub Client Utility\r\n * Enhanced with question-specific save logic\r\n */\r\n\r\nimport { Octokit } from \"octokit\";\r\n\r\n/**\r\n * Creates an authenticated Octokit instance.\r\n * @param {string} token - GitHub Personal Access Token\r\n */\r\nexport const getOctokit = (token) => {\r\n    return new Octokit({ auth: token });\r\n};\r\n\r\n/**\r\n * Gets the authenticated user's details.\r\n */\r\nexport const getUser = async (token) => {\r\n    const octokit = getOctokit(token);\r\n    const { data } = await octokit.rest.users.getAuthenticated();\r\n    return data;\r\n};\r\n\r\n/**\r\n * Saves a specific question update to a theme file on GitHub\r\n * ALWAYS uses PR flow to avoid SHA mismatch issues\r\n * @param {string} token - GitHub Token\r\n * @param {string} owner - Repo owner\r\n * @param {string} repo - Repo name  \r\n * @param {string} path - File path (e.g. 'public/data/7_les_pietons.json')\r\n * @param {number} questionId - ID of the question to update\r\n * @param {object} updatedQuestion - New question data\r\n * @param {string} message - Commit message\r\n * @param {object} user - User object from getUser()\r\n * @returns {Promise<object>} - Result with type ('pr') and url\r\n */\r\nexport const saveQuestionToGitHub = async (token, owner, repo, path, questionId, updatedQuestion, message, user) => {\r\n    const octokit = getOctokit(token);\r\n\r\n    console.log(`[saveQuestionToGitHub] Fetching latest version of ${path}...`);\r\n\r\n    // Get the latest file content and SHA with cache busting\r\n    const cacheBuster = Date.now();\r\n    const { data: fileData } = await octokit.request(`GET /repos/${owner}/${repo}/contents/${path}?_=${cacheBuster}`, {\r\n        owner,\r\n        repo,\r\n        path\r\n    });\r\n\r\n    const currentSha = fileData.sha;\r\n    console.log(`[saveQuestionToGitHub] Current SHA: ${currentSha}`);\r\n\r\n    // Decode content\r\n    const currentContent = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));\r\n    const originalContentString = JSON.stringify(currentContent, null, 2);\r\n\r\n    // Find and update the question\r\n    const questionIndex = currentContent.questions.findIndex(q => q.id === questionId);\r\n    if (questionIndex === -1) {\r\n        throw new Error(`Question with ID ${questionId} not found in ${path}`);\r\n    }\r\n\r\n    // Merge the update\r\n    currentContent.questions[questionIndex] = {\r\n        ...currentContent.questions[questionIndex],\r\n        ...updatedQuestion\r\n    };\r\n\r\n    const newContent = JSON.stringify(currentContent, null, 2);\r\n\r\n    // Check if content actually changed\r\n    if (newContent === originalContentString) {\r\n        console.log('[saveQuestionToGitHub] Content unchanged, skipping commit');\r\n        return { type: 'unchanged', message: 'No changes detected' };\r\n    }\r\n\r\n    console.log(`[saveQuestionToGitHub] Content changed, committing directly...`);\r\n\r\n    await octokit.rest.repos.createOrUpdateFileContents({\r\n        owner,\r\n        repo,\r\n        path,\r\n        message,\r\n        content: btoa(unescape(encodeURIComponent(newContent))),\r\n        sha: currentSha,\r\n        branch: 'main'\r\n    });\r\n\r\n    console.log('[saveQuestionToGitHub] Successfully committed to repository');\r\n    return { \r\n        type: 'commit', \r\n        url: `https://github.com/${owner}/${repo}/blob/main/${path}` \r\n    };\r\n};\r\n\r\n/**\r\n * Legacy saveToGitHub for backward compatibility\r\n * @deprecated Use saveQuestionToGitHub instead\r\n */\r\nexport const saveToGitHub = async (token, owner, repo, path, content, message, user, providedSha = null) => {\r\n    const octokit = getOctokit(token);\r\n\r\n    //ALWAYS get the LATEST file SHA right before committing\r\n    let sha;\r\n    try {\r\n        const cacheBuster = Date.now();\r\n        const { data } = await octokit.request(`GET /repos/${owner}/${repo}/contents/${path}?_=${cacheBuster}`, {\r\n            owner,\r\n            repo,\r\n            path\r\n        });\r\n        sha = data.sha;\r\n        console.log(`[saveToGitHub] Fetched latest SHA with cache bypass: ${sha}`);\r\n    } catch (e) {\r\n        console.error(\"File not found on GitHub or error fetching:\", e);\r\n    }\r\n\r\n    if (user.login === owner) {\r\n        await octokit.rest.repos.createOrUpdateFileContents({\r\n            owner,\r\n            repo,\r\n            path,\r\n            message,\r\n            content: btoa(unescape(encodeURIComponent(content))),\r\n            sha,\r\n        });\r\n        return { type: 'commit', url: `https://github.com/${owner}/${repo}/blob/main/${path}` };\r\n    } else {\r\n        // Fork & PR logic...\r\n        const fork = await octokit.rest.repos.createFork({ owner, repo });\r\n        const forkOwner = fork.data.owner.login;\r\n\r\n        await new Promise(r => setTimeout(r, 2000));\r\n\r\n        const branchName = `fix/question-${Date.now()}`;\r\n\r\n        const { data: refData } = await octokit.rest.git.getRef({\r\n            owner: forkOwner,\r\n            repo,\r\n            ref: 'heads/main'\r\n        });\r\n\r\n        await octokit.rest.git.createRef({\r\n            owner: forkOwner,\r\n            repo,\r\n            ref: `refs/heads/${branchName}`,\r\n            sha: refData.object.sha\r\n        });\r\n\r\n        await octokit.rest.repos.createOrUpdateFileContents({\r\n            owner: forkOwner,\r\n            repo,\r\n            path,\r\n            message,\r\n            content: btoa(unescape(encodeURIComponent(content))),\r\n            sha,\r\n            branch: branchName\r\n        });\r\n\r\n        const pr = await octokit.rest.pulls.create({\r\n            owner,\r\n            repo,\r\n            title: message,\r\n            head: `${forkOwner}:${branchName}`,\r\n            base: 'main',\r\n            body: `Proposed fix by ${user.login} using Gemini AI.`\r\n        });\r\n\r\n        return { type: 'pr', url: pr.data.html_url };\r\n    }\r\n};\r\n\r\n/**\r\n * Generic file fetcher from GitHub\r\n */\r\nexport const fetchFileContent = async (token, owner, repo, path) => {\r\n    const octokit = getOctokit(token);\r\n    const cacheBuster = Date.now();\r\n    \r\n    try {\r\n        const { data } = await octokit.request(`GET /repos/${owner}/${repo}/contents/${path}?_=${cacheBuster}`, {\r\n            owner,\r\n            repo,\r\n            path\r\n        });\r\n        \r\n        // Decode content (Base64 -> UTF-8)\r\n        const content = decodeURIComponent(escape(atob(data.content)));\r\n        return { content, sha: data.sha };\r\n    } catch (e) {\r\n        if (e.status === 404) return null; // File doesn't exist yet\r\n        throw e;\r\n    }\r\n};\r\n\r\n/**\r\n * Generic file saver to GitHub (Direct Commit)\r\n */\r\nexport const saveFileContent = async (token, owner, repo, path, content, message, sha = null) => {\r\n    const octokit = getOctokit(token);\r\n\r\n    // If SHA not provided, try to fetch it first to allow overwriting\r\n    if (!sha) {\r\n        try {\r\n            const existing = await fetchFileContent(token, owner, repo, path);\r\n            if (existing) sha = existing.sha;\r\n        } catch (e) {\r\n            // Ignore error, assume new file\r\n        }\r\n    }\r\n\r\n    await octokit.rest.repos.createOrUpdateFileContents({\r\n        owner,\r\n        repo,\r\n        path,\r\n        message,\r\n        content: btoa(unescape(encodeURIComponent(content))),\r\n        sha,\r\n        branch: 'main'\r\n    });\r\n\r\n    return { success: true };\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\test\\Documents\\permis\\permis-online-free\\src\\utils\\groq.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]